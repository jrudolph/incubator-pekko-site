<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Cluster Sharding concepts · Apache Pekko</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Apache Pekko" class="md-header-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Apache Pekko
</span>
<span class="md-header-nav__topic">
Cluster Sharding concepts
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Apache Pekko" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
<a href="../index.html" title="Apache Pekko">
Apache Pekko
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../downloads.html" class="page">Downloads</a></li>
  <li><a href="../documentation.html" class="page">Documentation</a>
  <ul>
    <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
    <li><a href="../general/index.html" class="page">General Concepts</a></li>
    <li><a href="../typed/index.html" class="page">Actors</a></li>
    <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
    <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
    <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
    <li><a href="../stream/index.html" class="page">Streams</a></li>
    <li><a href="../discovery/index.html" class="page">Discovery</a></li>
    <li><a href="../index-utilities.html" class="page">Utilities</a></li>
    <li><a href="../common/other-modules.html" class="page">Other Apache Pekko modules</a></li>
    <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
    <li><a href="../project/index.html" class="page">Project Information</a></li>
    <li><a href="../index-classic.html" class="page">Pekko Classic</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../typed/cluster-sharding-concepts.html#cluster-sharding-concepts" class="header">Cluster Sharding concepts</a>
  <ul>
    <li><a href="../typed/cluster-sharding-concepts.html#scenarios" class="header">Scenarios</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#shard-location" class="header">Shard location</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#shard-rebalancing" class="header">Shard rebalancing</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#shardcoordinator-state" class="header">ShardCoordinator state</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#message-ordering" class="header">Message ordering</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#reliable-delivery" class="header">Reliable delivery</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#overhead" class="header">Overhead</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.6.20+81-523134c3+20230202-1514*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../typed/cluster-sharding-concepts.html#cluster-sharding-concepts" class="header">Cluster Sharding concepts</a>
  <ul>
    <li><a href="../typed/cluster-sharding-concepts.html#scenarios" class="header">Scenarios</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#shard-location" class="header">Shard location</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#shard-rebalancing" class="header">Shard rebalancing</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#shardcoordinator-state" class="header">ShardCoordinator state</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#message-ordering" class="header">Message ordering</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#reliable-delivery" class="header">Reliable delivery</a></li>
    <li><a href="../typed/cluster-sharding-concepts.html#overhead" class="header">Overhead</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#cluster-sharding-concepts" name="cluster-sharding-concepts" class="anchor"><span class="anchor-link"></span></a>Cluster Sharding concepts</h1>
<p>The <code>ShardRegion</code> actor is started on each node in the cluster, or group of nodes tagged with a specific role. The <code>ShardRegion</code> is created with two application specific functions to extract the entity identifier and the shard identifier from incoming messages. A <code>Shard</code> is a group of entities that will be managed together. For the first message in a specific shard the <code>ShardRegion</code> requests the location of the shard from a central coordinator, the <code>ShardCoordinator</code>.</p>
<p>The <code>ShardCoordinator</code> decides which <code>ShardRegion</code> shall own the <code>Shard</code> and informs that <code>ShardRegion</code>. The region will confirm this request and create the <code>Shard</code> supervisor as a child actor. The individual <code>Entities</code> will then be created when needed by the <code>Shard</code> actor. Incoming messages thus travel via the <code>ShardRegion</code> and the <code>Shard</code> to the target <code>Entity</code>.</p>
<p>If the shard home is another <code>ShardRegion</code> instance messages will be forwarded to that <code>ShardRegion</code> instance instead. While resolving the location of a shard incoming messages for that shard are buffered and later delivered when the shard home is known. Subsequent messages to the resolved shard can be delivered to the target destination immediately without involving the <code>ShardCoordinator</code>.</p>
<h3><a href="#scenarios" name="scenarios" class="anchor"><span class="anchor-link"></span></a>Scenarios</h3>
<p>Once a <code>Shard</code> location is known <code>ShardRegion</code>s send messages directly. Here are the scenarios for getting to this state. In the scenarios the following notation is used:</p>
<ul>
  <li><code>SC</code> - ShardCoordinator</li>
  <li><code>M#</code> - Message 1, 2, 3, etc</li>
  <li><code>SR#</code> - ShardRegion 1, 2 3, etc</li>
  <li><code>S#</code> - Shard 1 2 3, etc</li>
  <li><code>E#</code> - Entity 1 2 3, etc. An entity refers to an Actor managed by Cluster Sharding.</li>
</ul>
<p>Where <code>#</code> is a number to distinguish between instances as there are multiple in the Cluster.</p>
<h4><a href="#scenario-1-message-to-an-unknown-shard-that-belongs-to-the-local-shardregion" name="scenario-1-message-to-an-unknown-shard-that-belongs-to-the-local-shardregion" class="anchor"><span class="anchor-link"></span></a>Scenario 1: Message to an unknown shard that belongs to the local ShardRegion</h4>
<ol>
  <li>Incoming message <code>M1</code> to <code>ShardRegion</code> instance <code>SR1</code>.</li>
  <li><code>M1</code> is mapped to shard <code>S1</code>. <code>SR1</code> doesn&rsquo;t know about <code>S1</code>, so it asks the <code>SC</code> for the location of <code>S1</code>.</li>
  <li><code>SC</code> answers that the home of <code>S1</code> is <code>SR1</code>.</li>
  <li><code>SR1</code> creates child actor shard <code>S1</code> and forwards the message to it.</li>
  <li><code>S1</code> creates child actor for <code>E1</code> and forwards the message to it.</li>
  <li>All incoming messages for <code>S1</code> which arrive at <code>SR1</code> can be handled by <code>SR1</code> without <code>SC</code>.</li>
</ol>
<h4><a href="#scenario-2-message-to-an-unknown-shard-that-belongs-to-a-remote-shardregion" name="scenario-2-message-to-an-unknown-shard-that-belongs-to-a-remote-shardregion" class="anchor"><span class="anchor-link"></span></a>Scenario 2: Message to an unknown shard that belongs to a remote ShardRegion</h4>
<ol>
  <li>Incoming message <code>M2</code> to <code>ShardRegion</code> instance <code>SR1</code>.</li>
  <li><code>M2</code> is mapped to <code>S2</code>. <code>SR1</code> doesn&rsquo;t know about <code>S2</code>, so it asks <code>SC</code> for the location of <code>S2</code>.</li>
  <li><code>SC</code> answers that the home of <code>S2</code> is <code>SR2</code>.</li>
  <li><code>SR1</code> sends buffered messages for <code>S2</code> to <code>SR2</code>.</li>
  <li>All incoming messages for <code>S2</code> which arrive at <code>SR1</code> can be handled by <code>SR1</code> without <code>SC</code>. It forwards messages to <code>SR2</code>.</li>
  <li><code>SR2</code> receives message for <code>S2</code>, ask <code>SC</code>, which answers that the home of <code>S2</code> is <code>SR2</code>, and we are in Scenario 1 (but for <code>SR2</code>).</li>
</ol>
<h3><a href="#shard-location" name="shard-location" class="anchor"><span class="anchor-link"></span></a>Shard location</h3>
<p>To make sure that at most one instance of a specific entity actor is running somewhere in the cluster it is important that all nodes have the same view of where the shards are located. Therefore the shard allocation decisions are taken by the central <code>ShardCoordinator</code>, which is running as a cluster singleton, i.e. one instance on the oldest member among all cluster nodes or a group of nodes tagged with a specific role.</p>
<p>The logic that decides where a shard is to be located is defined in a pluggable <a href="cluster-sharding.html#shard-allocation">shard allocation strategy</a>.</p>
<h3><a href="#shard-rebalancing" name="shard-rebalancing" class="anchor"><span class="anchor-link"></span></a>Shard rebalancing</h3>
<p>To be able to use newly added members in the cluster the coordinator facilitates rebalancing of shards, i.e. migrate entities from one node to another. In the rebalance process the coordinator first notifies all <code>ShardRegion</code> actors that a handoff for a shard has started. That means they will start buffering incoming messages for that shard, in the same way as if the shard location is unknown. During the rebalance process the coordinator will not answer any requests for the location of shards that are being rebalanced, i.e. local buffering will continue until the handoff is completed. The <code>ShardRegion</code> responsible for the rebalanced shard will stop all entities in that shard by sending the specified <code>stopMessage</code> (default <code>PoisonPill</code>) to them. When all entities have been terminated the <code>ShardRegion</code> owning the entities will acknowledge the handoff as completed to the coordinator. Thereafter the coordinator will reply to requests for the location of the shard, thereby allocating a new home for the shard, and then buffered messages in the <code>ShardRegion</code> actors are delivered to the new location. This means that the state of the entities are not transferred or migrated. If the state of the entities are of importance it should be persistent (durable), e.g. with <a href="persistence.html">Persistence</a> (or see <a href="../persistence.html">Classic Persistence</a>), so that it can be recovered at the new location.</p>
<p>The logic that decides which shards to rebalance is defined in a pluggable shard allocation strategy. The default implementation <code>LeastShardAllocationStrategy</code> allocates new shards to the <code>ShardRegion</code> (node) with least number of previously allocated shards. </p>
<p>See also <a href="cluster-sharding.html#shard-allocation">Shard allocation</a>.</p>
<h3><a href="#shardcoordinator-state" name="shardcoordinator-state" class="anchor"><span class="anchor-link"></span></a>ShardCoordinator state</h3>
<p>The state of shard locations in the <code>ShardCoordinator</code> is persistent (durable) with <a href="distributed-data.html">Distributed Data</a> (or see <a href="../distributed-data.html">Classic Distributed Data</a>) to survive failures. </p>
<p>When a crashed or unreachable coordinator node has been removed (via down) from the cluster a new <code>ShardCoordinator</code> singleton actor will take over and the state is recovered. During such a failure period shards with a known location are still available, while messages for new (unknown) shards are buffered until the new <code>ShardCoordinator</code> becomes available.</p>
<h3><a href="#message-ordering" name="message-ordering" class="anchor"><span class="anchor-link"></span></a>Message ordering</h3>
<p>As long as a sender uses the same <code>ShardRegion</code> actor to deliver messages to an entity actor the order of the messages is preserved. As long as the buffer limit is not reached messages are delivered on a best effort basis, with at-most once delivery semantics, in the same way as ordinary message sending.</p>
<h3><a href="#reliable-delivery" name="reliable-delivery" class="anchor"><span class="anchor-link"></span></a>Reliable delivery</h3>
<p>Reliable end-to-end messaging, with at-least-once semantics can be added by using the <a href="reliable-delivery.html#sharding">Reliable Delivery</a> feature.</p>
<h3><a href="#overhead" name="overhead" class="anchor"><span class="anchor-link"></span></a>Overhead</h3>
<p>Some additional latency is introduced for messages targeted to new or previously unused shards due to the round-trip to the coordinator. Rebalancing of shards may also add latency. This should be considered when designing the application specific shard resolution, e.g. to avoid too fine grained shards. Once a shard&rsquo;s location is known the only overhead is sending a message via the <code>ShardRegion</code> rather than directly.</p>
</div>
<div>
<a href="https://github.com/apache/incubator-pekko/tree/main/docs/src/main/paradox/typed/cluster-sharding-concepts.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.6.20+81-523134c3+20230202-1514*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../typed/cluster-sharding.html" title="Cluster Sharding" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Cluster Sharding
</span>
</div>
</a>
<a href="../typed/cluster-sharded-daemon-process.html" title="Sharded Daemon Process" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Sharded Daemon Process
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright © 2023 The Apache Software Foundation, Licensed under the Apache License, Version 2.0
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../assets/js/groups.js"></script>
</body>
</html>
