<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Testing Â· Apache Pekko</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Apache Pekko" class="md-header-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Apache Pekko
</span>
<span class="md-header-nav__topic">
Testing
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Apache Pekko" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
<a href="../index.html" title="Apache Pekko">
Apache Pekko
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../downloads.html" class="page">Downloads</a></li>
  <li><a href="../documentation.html" class="page">Documentation</a>
  <ul>
    <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
    <li><a href="../general/index.html" class="page">General Concepts</a></li>
    <li><a href="../typed/index.html" class="page">Actors</a></li>
    <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
    <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
    <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
    <li><a href="../stream/index.html" class="page">Streams</a></li>
    <li><a href="../discovery/index.html" class="page">Discovery</a></li>
    <li><a href="../index-utilities.html" class="page">Utilities</a></li>
    <li><a href="../common/other-modules.html" class="page">Other Apache Pekko modules</a></li>
    <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
    <li><a href="../project/index.html" class="page">Project Information</a></li>
    <li><a href="../index-classic.html" class="page">Pekko Classic</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../typed/persistence-testing.html#testing" class="header">Testing</a>
  <ul>
    <li><a href="../typed/persistence-testing.html#module-info" class="header">Module info</a></li>
    <li><a href="../typed/persistence-testing.html#unit-testing" class="header">Unit testing</a></li>
    <li><a href="../typed/persistence-testing.html#persistence-testkit" class="header">Persistence TestKit</a></li>
    <li><a href="../typed/persistence-testing.html#integration-testing" class="header">Integration testing</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.6.20+81-523134c3+20230202-1514*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../typed/persistence-testing.html#testing" class="header">Testing</a>
  <ul>
    <li><a href="../typed/persistence-testing.html#module-info" class="header">Module info</a></li>
    <li><a href="../typed/persistence-testing.html#unit-testing" class="header">Unit testing</a></li>
    <li><a href="../typed/persistence-testing.html#persistence-testkit" class="header">Persistence TestKit</a></li>
    <li><a href="../typed/persistence-testing.html#integration-testing" class="header">Integration testing</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#testing" name="testing" class="anchor"><span class="anchor-link"></span></a>Testing</h1>
<h2><a href="#module-info" name="module-info" class="anchor"><span class="anchor-link"></span></a>Module info</h2>
<p>To use Pekko Persistence TestKit, add the module to your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val PekkoVersion = "2.6.20+81-523134c3+20230202-1514-SNAPSHOT"
libraryDependencies ++= Seq(
  "org.apache.pekko" %% "pekko-persistence-typed" % PekkoVersion,
  "org.apache.pekko" %% "pekko-persistence-testkit" % PekkoVersion % Test
)</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
      &lt;artifactId&gt;pekko-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.6.20+81-523134c3+20230202-1514-SNAPSHOT&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
    &lt;artifactId&gt;pekko-persistence-typed_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
    &lt;artifactId&gt;pekko-persistence-testkit_${scala.binary.version}&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("org.apache.pekko:pekko-bom_${versions.ScalaBinary}:2.6.20+81-523134c3+20230202-1514-SNAPSHOT")

  implementation "org.apache.pekko:pekko-persistence-typed_${versions.ScalaBinary}"
  testImplementation "org.apache.pekko:pekko-persistence-testkit_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<table class="project-info">
<tr><th colspan="2">Project Info: Pekko Persistence Testkit</th></tr>
  <tr><th>Artifact</th><td><div>org.apache.pekko</div>
  <div>pekko-persistence-testkit</div>
  <div>2.6.20+81-523134c3+20230202-1514-SNAPSHOT</div>
  <div><a href="project/links.html#snapshots-repository">Snapshots are available</a></div>
  </td></tr>
  <tr><th>JDK versions</th><td><div>Adopt OpenJDK 8</div><div>Adopt OpenJDK 11</div></td></tr>
  <tr><th>Scala versions</th><td>2.13.8, 2.12.16, 3.1.2</td></tr>
  <tr><th>JPMS module name</th><td>pekko.persistence.testkit</td></tr>
  <tr><th>License</th><td><div><a href="https://www.apache.org/licenses/LICENSE-2.0.html" target="_blank" rel="noopener noreferrer">Apache-2.0</a></div>
  </td></tr>
  
  <tr><th>Home page</th><td><a href="https://pekko.apache.org/">https://pekko.apache.org/</a></td></tr>
  <tr><th>API documentation</th><td>
  <div><a href="https://pekko.apache.org/api/pekko/snapshot/pekko/persistence/testkit/scaladsl/index.html" target="_blank" rel="noopener noreferrer">API (Scaladoc)</a></div>
  <div><a href="https://pekko.apache.org/japi/pekko/snapshot/pekko/persistence/testkit/javadsl/package-summary.html" target="_blank" rel="noopener noreferrer">API (Javadoc)</a></div>
  </td></tr>
  <tr><th>Forums</th><td>
  <div><a href="https://lists.apache.org/list.html?dev@pekko.apache.org" target="_blank" rel="noopener noreferrer">Apache Pekko Dev mailing list</a></div>
  <div><a href="https://github.com/apache/incubator-pekko/discussions" target="_blank" rel="noopener noreferrer">apache/incubator-pekko discussion</a></div>
  </td></tr>
  <tr><th>Release notes</th><td><a href="https://akka.io/blog/news-archive.html">akka.io blog</a></td></tr>
  <tr><th>Issues</th><td><a href="https://github.com/apache/incubator-pekko/issues" target="_blank" rel="noopener noreferrer">Github issues</a></td></tr>
  <tr><th>Sources</th><td><a href="https://github.com/apache/incubator-pekko" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-pekko</a></td></tr>
</table>

<h2><a href="#unit-testing" name="unit-testing" class="anchor"><span class="anchor-link"></span></a>Unit testing</h2>

<p><strong>Note!</strong> The <code>EventSourcedBehaviorTestKit</code> is a new feature, api may have changes breaking source compatibility in future versions.</p>

<p>Unit testing of <code>EventSourcedBehavior</code> can be done with the <span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/javadsl/EventSourcedBehaviorTestKit.html" title="org.apache.pekko.persistence.testkit.javadsl.EventSourcedBehaviorTestKit"><code>EventSourcedBehaviorTestKit</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/scaladsl/EventSourcedBehaviorTestKit.html" title="org.apache.pekko.persistence.testkit.scaladsl.EventSourcedBehaviorTestKit"><code>EventSourcedBehaviorTestKit</code></a></span>. It supports running one command at a time and you can assert that the synchronously returned result is as expected. The result contains the events emitted by the command and the new state after applying the events. It also has support for verifying the reply to a command.</p>

<p>You need to configure the <code>ActorSystem</code> with the <code>EventSourcedBehaviorTestKit.config</code>. The configuration enables the in-memory journal and snapshot storage.</p>

<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/cluster-sharding-typed/src/test/scala/docs/org/apache/pekko/cluster/sharding/typed/AccountExampleDocSpec.scala#L33-L34" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class AccountExampleDocSpec
    extends ScalaTestWithActorTestKit(EventSourcedBehaviorTestKit.config)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/cluster-sharding-typed/src/test/java/jdocs/org/apache/pekko/cluster/sharding/typed/AccountExampleDocTest.java#L47-L55" target="_blank" title="Go to snippet source">source</a><code class="language-java">@ClassRule
public static final TestKitJunitResource testKit =
    new TestKitJunitResource(EventSourcedBehaviorTestKit.config());

private EventSourcedBehaviorTestKit&lt;
        AccountEntity.Command, AccountEntity.Event, AccountEntity.Account&gt;
    eventSourcedTestKit =
        EventSourcedBehaviorTestKit.create(
            testKit.system(), AccountEntity.create(&quot;1&quot;, PersistenceId.of(&quot;Account&quot;, &quot;1&quot;)));</code></pre></dd>
</dl>
<p>A full test for the <code>AccountEntity</code>, which is shown in the <a href="persistence-style.html">Persistence Style Guide</a>, may look like this:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/cluster-sharding-typed/src/test/scala/docs/org/apache/pekko/cluster/sharding/typed/AccountExampleDocSpec.scala#L17-L91" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.pekko
import pekko.Done
import pekko.persistence.testkit.scaladsl.EventSourcedBehaviorTestKit
import pekko.persistence.typed.PersistenceId
import pekko.actor.testkit.typed.scaladsl.LogCapturing
import pekko.actor.testkit.typed.scaladsl.ScalaTestWithActorTestKit
import pekko.pattern.StatusReply
import org.scalatest.BeforeAndAfterEach
import org.scalatest.wordspec.AnyWordSpecLike

class AccountExampleDocSpec
    extends ScalaTestWithActorTestKit(EventSourcedBehaviorTestKit.config)
    with AnyWordSpecLike
    with BeforeAndAfterEach
    with LogCapturing {

  private val eventSourcedTestKit =
    EventSourcedBehaviorTestKit[AccountEntity.Command, AccountEntity.Event, AccountEntity.Account](
      system,
      AccountEntity(&quot;1&quot;, PersistenceId(&quot;Account&quot;, &quot;1&quot;)))

  override protected def beforeEach(): Unit = {
    super.beforeEach()
    eventSourcedTestKit.clear()
  }

  &quot;Account&quot; must {

    &quot;be created with zero balance&quot; in {
      val result = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))
      result.reply shouldBe StatusReply.Ack
      result.event shouldBe AccountEntity.AccountCreated
      result.stateOfType[AccountEntity.OpenedAccount].balance shouldBe 0
    }

    &quot;handle Withdraw&quot; in {
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))

      val result1 = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Deposit(100, _))
      result1.reply shouldBe StatusReply.Ack
      result1.event shouldBe AccountEntity.Deposited(100)
      result1.stateOfType[AccountEntity.OpenedAccount].balance shouldBe 100

      val result2 = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Withdraw(10, _))
      result2.reply shouldBe StatusReply.Ack
      result2.event shouldBe AccountEntity.Withdrawn(10)
      result2.stateOfType[AccountEntity.OpenedAccount].balance shouldBe 90
    }

    &quot;reject Withdraw overdraft&quot; in {
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Deposit(100, _))

      val result = eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Withdraw(110, _))
      result.reply.isError shouldBe true
      result.hasNoEvents shouldBe true
    }

    &quot;handle GetBalance&quot; in {
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.CreateAccount(_))
      eventSourcedTestKit.runCommand[StatusReply[Done]](AccountEntity.Deposit(100, _))

      val result = eventSourcedTestKit.runCommand[AccountEntity.CurrentBalance](AccountEntity.GetBalance(_))
      result.reply.balance shouldBe 100
      result.hasNoEvents shouldBe true
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/cluster-sharding-typed/src/test/java/jdocs/org/apache/pekko/cluster/sharding/typed/AccountExampleDocTest.java#L24-L140" target="_blank" title="Go to snippet source">source</a><code class="language-java">import java.math.BigDecimal;
import org.apache.pekko.actor.testkit.typed.javadsl.LogCapturing;
import org.apache.pekko.actor.testkit.typed.javadsl.TestKitJunitResource;
import org.apache.pekko.actor.typed.ActorRef;
import org.apache.pekko.persistence.testkit.javadsl.EventSourcedBehaviorTestKit;
import org.apache.pekko.persistence.testkit.javadsl.EventSourcedBehaviorTestKit.CommandResultWithReply;
import org.apache.pekko.persistence.typed.PersistenceId;

import org.junit.Before;
import org.junit.ClassRule;
import org.junit.Rule;
import org.junit.Test;

public class AccountExampleDocTest
{

  @ClassRule
  public static final TestKitJunitResource testKit =
      new TestKitJunitResource(EventSourcedBehaviorTestKit.config());

  private EventSourcedBehaviorTestKit&lt;
          AccountEntity.Command, AccountEntity.Event, AccountEntity.Account&gt;
      eventSourcedTestKit =
          EventSourcedBehaviorTestKit.create(
              testKit.system(), AccountEntity.create(&quot;1&quot;, PersistenceId.of(&quot;Account&quot;, &quot;1&quot;)));

  @Rule public final LogCapturing logCapturing = new LogCapturing();

  @Before
  public void beforeEach() {
    eventSourcedTestKit.clear();
  }

  @Test
  public void createWithEmptyBalance() {
    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result = eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    assertEquals(StatusReply.ack(), result.reply());
    assertEquals(AccountEntity.AccountCreated.INSTANCE, result.event());
    assertEquals(BigDecimal.ZERO, result.stateOfType(AccountEntity.OpenedAccount.class).balance);
  }

  @Test
  public void createWithUnHandle() {
    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result = eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    assertFalse(result.hasNoReply());
  }

  @Test
  public void handleWithdraw() {
    eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);

    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result1 =
            eventSourcedTestKit.runCommand(
                replyTo -&gt; new AccountEntity.Deposit(BigDecimal.valueOf(100), replyTo));
    assertEquals(StatusReply.ack(), result1.reply());
    assertEquals(
        BigDecimal.valueOf(100), result1.eventOfType(AccountEntity.Deposited.class).amount);
    assertEquals(
        BigDecimal.valueOf(100), result1.stateOfType(AccountEntity.OpenedAccount.class).balance);

    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result2 =
            eventSourcedTestKit.runCommand(
                replyTo -&gt; new AccountEntity.Withdraw(BigDecimal.valueOf(10), replyTo));
    assertEquals(StatusReply.ack(), result2.reply());
    assertEquals(BigDecimal.valueOf(10), result2.eventOfType(AccountEntity.Withdrawn.class).amount);
    assertEquals(
        BigDecimal.valueOf(90), result2.stateOfType(AccountEntity.OpenedAccount.class).balance);
  }

  @Test
  public void rejectWithdrawOverdraft() {
    eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    eventSourcedTestKit.runCommand(
        (ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) -&gt;
            new AccountEntity.Deposit(BigDecimal.valueOf(100), replyTo));

    CommandResultWithReply&lt;
            AccountEntity.Command, AccountEntity.Event, AccountEntity.Account, StatusReply&lt;Done&gt;&gt;
        result =
            eventSourcedTestKit.runCommand(
                replyTo -&gt; new AccountEntity.Withdraw(BigDecimal.valueOf(110), replyTo));
    assertTrue(result.reply().isError());
    assertTrue(result.hasNoEvents());
  }

  @Test
  public void handleGetBalance() {
    eventSourcedTestKit.runCommand(AccountEntity.CreateAccount::new);
    eventSourcedTestKit.runCommand(
        (ActorRef&lt;StatusReply&lt;Done&gt;&gt; replyTo) -&gt;
            new AccountEntity.Deposit(BigDecimal.valueOf(100), replyTo));

    CommandResultWithReply&lt;
            AccountEntity.Command,
            AccountEntity.Event,
            AccountEntity.Account,
            AccountEntity.CurrentBalance&gt;
        result = eventSourcedTestKit.runCommand(AccountEntity.GetBalance::new);
    assertEquals(BigDecimal.valueOf(100), result.reply().balance);
  }
}</code></pre></dd>
</dl>
<p>Serialization of commands, events and state are verified automatically. The serialization checks can be customized with the <code>SerializationSettings</code> when creating the <code>EventSourcedBehaviorTestKit</code>. By default, the serialization roundtrip is checked but the equality of the result of the serialization is not checked. <code>equals</code> must be implemented <span class="group-scala">(or using <code>case class</code>)</span> in the commands, events and state if <code>verifyEquality</code> is enabled.</p>
<p>To test recovery the <code>restart</code> method of the <code>EventSourcedBehaviorTestKit</code> can be used. It will restart the behavior, which will then recover from stored snapshot and events from previous commands. It&rsquo;s also possible to populate the storage with events or simulate failures by using the underlying <span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/javadsl/PersistenceTestKit.html" title="org.apache.pekko.persistence.testkit.javadsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/scaladsl/PersistenceTestKit.html" title="org.apache.pekko.persistence.testkit.scaladsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span>.</p>
<h2><a href="#persistence-testkit" name="persistence-testkit" class="anchor"><span class="anchor-link"></span></a>Persistence TestKit</h2>
<p><strong>Note!</strong> The <code>PersistenceTestKit</code> is a new feature, api may have changes breaking source compatibility in future versions.</p>
<p>Persistence testkit allows to check events saved in a storage, emulate storage operations and exceptions. To use the testkit you need to add the following dependency in your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val PekkoVersion = "2.6.20+81-523134c3+20230202-1514-SNAPSHOT"
libraryDependencies += "org.apache.pekko" %% "pekko-persistence-testkit" % PekkoVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
      &lt;artifactId&gt;pekko-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.6.20+81-523134c3+20230202-1514-SNAPSHOT&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
    &lt;artifactId&gt;pekko-persistence-testkit_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("org.apache.pekko:pekko-bom_${versions.ScalaBinary}:2.6.20+81-523134c3+20230202-1514-SNAPSHOT")

  implementation "org.apache.pekko:pekko-persistence-testkit_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<p>There are two testkit classes which have similar api:</p>
<ul>
  <li><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/javadsl/PersistenceTestKit.html" title="org.apache.pekko.persistence.testkit.javadsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/scaladsl/PersistenceTestKit.html" title="org.apache.pekko.persistence.testkit.scaladsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span> class is for events</li>
  <li><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/javadsl/SnapshotTestKit.html" title="org.apache.pekko.persistence.testkit.javadsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/scaladsl/SnapshotTestKit.html" title="org.apache.pekko.persistence.testkit.scaladsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span> class is for snapshots</li>
</ul>
<p>The testkit classes have two corresponding plugins which emulate the behavior of the storages: </p>
<ul>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/PersistenceTestKitPlugin.html" title="org.apache.pekko.persistence.testkit.PersistenceTestKitPlugin"><code>PersistenceTestKitPlugin</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/PersistenceTestKitPlugin.html" title="org.apache.pekko.persistence.testkit.PersistenceTestKitPlugin"><code>PersistenceTestKitPlugin</code></a></span> class emulates a events storage</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/PersistenceTestKitSnapshotPlugin.html" title="org.apache.pekko.persistence.testkit.PersistenceTestKitSnapshotPlugin"><code>PersistenceTestKitSnapshotPlugin</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/PersistenceTestKitSnapshotPlugin.html" title="org.apache.pekko.persistence.testkit.PersistenceTestKitSnapshotPlugin"><code>PersistenceTestKitSnapshotPlugin</code></a></span> class emulates a snapshots storage</li>
</ul>
<p><strong>Note!</strong> The corresponding plugins <strong>must</strong> be configured in the actor system which is used to initialize the particular testkit class:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/Configuration.scala#L24-L31" target="_blank" title="Go to snippet source">source</a><code class="language-scala"><br/>val yourConfiguration = ConfigFactory.defaultApplication()

val system =
  ActorSystem(??? /*some behavior*/, &quot;test-system&quot;, PersistenceTestKitPlugin.config.withFallback(yourConfiguration))

val testKit = PersistenceTestKit(system)
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/Configuration.java#L28-L38" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class PersistenceTestKitConfig {

  Config conf =
      PersistenceTestKitPlugin.getInstance()
          .config()
          .withFallback(ConfigFactory.defaultApplication());

  ActorSystem&lt;Command&gt; system = ActorSystem.create(new SomeBehavior(), &quot;example&quot;, conf);

  PersistenceTestKit testKit = PersistenceTestKit.create(system);
}</code></pre></dd>
</dl>
<p>and</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/Configuration.scala#L39-L48" target="_blank" title="Go to snippet source">source</a><code class="language-scala"><br/>val yourConfiguration = ConfigFactory.defaultApplication()

val system = ActorSystem(
  ??? /*some behavior*/,
  &quot;test-system&quot;,
  PersistenceTestKitSnapshotPlugin.config.withFallback(yourConfiguration))

val testKit = SnapshotTestKit(system)
</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/Configuration.java#L42-L52" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class SnapshotTestKitConfig {

  Config conf =
      PersistenceTestKitSnapshotPlugin.getInstance()
          .config()
          .withFallback(ConfigFactory.defaultApplication());

  ActorSystem&lt;Command&gt; system = ActorSystem.create(new SomeBehavior(), &quot;example&quot;, conf);

  SnapshotTestKit testKit = SnapshotTestKit.create(system);
}</code></pre></dd>
</dl>
<p>A typical scenario is to create a persistent actor, send commands to it and check that it persists events as it is expected:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L37-L73" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.pekko
import pekko.actor.testkit.typed.scaladsl.ScalaTestWithActorTestKit
import pekko.persistence.testkit.PersistenceTestKitPlugin
import pekko.persistence.testkit.scaladsl.PersistenceTestKit

class PersistenceTestKitSampleSpec
    extends ScalaTestWithActorTestKit(PersistenceTestKitPlugin.config.withFallback(ConfigFactory.defaultApplication()))
    with AnyWordSpecLike
    with BeforeAndAfterEach {

  val persistenceTestKit = PersistenceTestKit(system)

  override def beforeEach(): Unit = {
    persistenceTestKit.clearAll()
  }

  &quot;Persistent actor&quot; should {

    &quot;persist all events&quot; in {

      val persistenceId = PersistenceId.ofUniqueId(&quot;your-persistence-id&quot;)
      val persistentActor = spawn(
        EventSourcedBehavior[Cmd, Evt, State](
          persistenceId,
          emptyState = State.empty,
          commandHandler = (_, cmd) =&gt; Effect.persist(Evt(cmd.data)),
          eventHandler = (state, evt) =&gt; state.updated(evt)))
      val cmd = Cmd(&quot;data&quot;)

      persistentActor ! cmd

      val expectedPersistedEvent = Evt(cmd.data)
      persistenceTestKit.expectNextPersisted(persistenceId.id, expectedPersistedEvent)
    }

  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/PersistenceTestKitSampleTest.java#L35-L133" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class PersistenceTestKitSampleTest extends AbstractJavaTest {

  @ClassRule
  public static final TestKitJunitResource testKit =
      new TestKitJunitResource(
          PersistenceTestKitPlugin.getInstance()
              .config()
              .withFallback(ConfigFactory.defaultApplication()));

  PersistenceTestKit persistenceTestKit = PersistenceTestKit.create(testKit.system());

  @Before
  public void beforeEach() {
    persistenceTestKit.clearAll();
  }

  @Test
  public void test() {
    PersistenceId persistenceId = PersistenceId.ofUniqueId(&quot;some-id&quot;);
    ActorRef&lt;YourPersistentBehavior.Cmd&gt; ref =
        testKit.spawn(YourPersistentBehavior.create(persistenceId));

    YourPersistentBehavior.Cmd cmd = new YourPersistentBehavior.Cmd(&quot;data&quot;);
    ref.tell(cmd);
    YourPersistentBehavior.Evt expectedEventPersisted = new YourPersistentBehavior.Evt(cmd.data);

    persistenceTestKit.expectNextPersisted(persistenceId.id(), expectedEventPersisted);
  }
}

class YourPersistentBehavior
    extends EventSourcedBehavior&lt;
        YourPersistentBehavior.Cmd, YourPersistentBehavior.Evt, YourPersistentBehavior.State&gt; {

  static final class Cmd implements CborSerializable {

    public final String data;

    @JsonCreator
    public Cmd(String data) {
      this.data = data;
    }
  }

  static final class Evt implements CborSerializable {

    public final String data;

    @JsonCreator
    public Evt(String data) {
      this.data = data;
    }

    @Override
    public boolean equals(Object o) {
      if (this == o) return true;
      if (o == null || getClass() != o.getClass()) return false;

      Evt evt = (Evt) o;

      return data.equals(evt.data);
    }

    @Override
    public int hashCode() {
      return data.hashCode();
    }
  }

  static final class State implements CborSerializable {}

  static Behavior&lt;Cmd&gt; create(PersistenceId persistenceId) {
    return Behaviors.setup(context -&gt; new YourPersistentBehavior(persistenceId));
  }

  private YourPersistentBehavior(PersistenceId persistenceId) {
    super(persistenceId);
  }

  @Override
  public State emptyState() {
    // some state
    return new State();
  }

  @Override
  public CommandHandler&lt;Cmd, Evt, State&gt; commandHandler() {
    return newCommandHandlerBuilder()
        .forAnyState()
        .onCommand(Cmd.class, command -&gt; Effect().persist(new Evt(command.data)))
        .build();
  }

  @Override
  public EventHandler&lt;State, Evt&gt; eventHandler() {
    // TODO handle events
    return newEventHandlerBuilder().forAnyState().onEvent(Evt.class, (state, evt) -&gt; state).build();
  }
}</code></pre></dd>
</dl>
<p>You can safely use persistence testkit in combination with main pekko testkit.</p>
<p>The main methods of the api allow to (see <span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/javadsl/PersistenceTestKit.html" title="org.apache.pekko.persistence.testkit.javadsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/scaladsl/PersistenceTestKit.html" title="org.apache.pekko.persistence.testkit.scaladsl.PersistenceTestKit"><code>PersistenceTestKit</code></a></span> and <span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/javadsl/SnapshotTestKit.html" title="org.apache.pekko.persistence.testkit.javadsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/scaladsl/SnapshotTestKit.html" title="org.apache.pekko.persistence.testkit.scaladsl.SnapshotTestKit"><code>SnapshotTestKit</code></a></span> for more details):</p>
<ul>
  <li>check if the given event/snapshot object is the next persisted in the storage.</li>
  <li>read a sequence of persisted events/snapshots.</li>
  <li>check that no events/snapshots have been persisted in the storage.</li>
  <li>throw the default exception from the storage on attempt to persist, read or delete the following event/snapshot.</li>
  <li>clear the events/snapshots persisted in the storage.</li>
  <li>reject the events, but not snapshots (rejections are not supported for snapshots in the original api).</li>
  <li>set your own <a href="#setting-your-own-policy-for-the-storage">policy</a> which emulates the work of the storage. Policy determines what to do when persistence needs to execute some operation on the storage (i.e. read, delete, etc.).</li>
  <li>get all the events/snapshots persisted in the storage</li>
  <li>put the events/snapshots in the storage to test recovery</li>
</ul>
<h4><a href="#setting-your-own-policy-for-the-storage" name="setting-your-own-policy-for-the-storage" class="anchor"><span class="anchor-link"></span></a>Setting your own policy for the storage</h4>
<p>You can implement and set your own policy for the storage to control its actions on particular operations, for example you can fail or reject events on your own conditions. Implement the <span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingPolicy.html" title="org.apache.pekko.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy[EventStorage.JournalOperation]</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingPolicy.html" title="org.apache.pekko.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy&lt;EventStorage.JournalOperation&gt;</code></a></span> <span class="group-scala">trait</span><span class="group-java">interface</span> for event storage or <span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingPolicy.html" title="org.apache.pekko.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy[SnapshotStorage.SnapshotOperation]</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingPolicy.html" title="org.apache.pekko.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy&lt;SnapshotStorage.SnapshotOperation&gt;</code></a></span> <span class="group-scala">trait</span><span class="group-java">interface</span> for snapshot storage, and set it with <code>withPolicy()</code> method.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L132-L172" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class PersistenceTestKitSampleSpecWithPolicy
    extends ScalaTestWithActorTestKit(PersistenceTestKitPlugin.config.withFallback(ConfigFactory.defaultApplication()))
    with AnyWordSpecLike
    with BeforeAndAfterEach {

  val persistenceTestKit = PersistenceTestKit(system)

  override def beforeEach(): Unit = {
    persistenceTestKit.clearAll()
    persistenceTestKit.resetPolicy()
  }

  &quot;Testkit policy&quot; should {

    &quot;fail all operations with custom exception&quot; in {
      val policy = new EventStorage.JournalPolicies.PolicyType {

        class CustomFailure extends RuntimeException

        override def tryProcess(persistenceId: String, processingUnit: JournalOperation): ProcessingResult =
          processingUnit match {
            case WriteEvents(_) =&gt; StorageFailure(new CustomFailure)
            case _              =&gt; ProcessingSuccess
          }
      }
      persistenceTestKit.withPolicy(policy)

      val persistenceId = PersistenceId.ofUniqueId(&quot;your-persistence-id&quot;)
      val persistentActor = spawn(
        EventSourcedBehavior[Cmd, Evt, State](
          persistenceId,
          emptyState = State.empty,
          commandHandler = (_, cmd) =&gt; Effect.persist(Evt(cmd.data)),
          eventHandler = (state, evt) =&gt; state.updated(evt)))

      persistentActor ! Cmd(&quot;data&quot;)
      persistenceTestKit.expectNothingPersisted(persistenceId.id)

    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/PersistenceTestKitPolicySampleTest.java#L34-L76" target="_blank" title="Go to snippet source">source</a><code class="language-java">public class PersistenceTestKitPolicySampleTest extends AbstractJavaTest {

  @ClassRule
  public static final TestKitJunitResource testKit =
      new TestKitJunitResource(
          PersistenceTestKitPlugin.getInstance()
              .config()
              .withFallback(ConfigFactory.defaultApplication()));

  PersistenceTestKit persistenceTestKit = PersistenceTestKit.create(testKit.system());

  @Before
  public void beforeEach() {
    persistenceTestKit.clearAll();
    persistenceTestKit.resetPolicy();
  }

  @Test
  public void test() {
    SampleEventStoragePolicy policy = new SampleEventStoragePolicy();
    persistenceTestKit.withPolicy(policy);

    PersistenceId persistenceId = PersistenceId.ofUniqueId(&quot;some-id&quot;);
    ActorRef&lt;YourPersistentBehavior.Cmd&gt; ref =
        testKit.spawn(YourPersistentBehavior.create(persistenceId));

    YourPersistentBehavior.Cmd cmd = new YourPersistentBehavior.Cmd(&quot;data&quot;);
    ref.tell(cmd);

    persistenceTestKit.expectNothingPersisted(persistenceId.id());
  }

  static class SampleEventStoragePolicy implements ProcessingPolicy&lt;JournalOperation&gt; {
    @Override
    public ProcessingResult tryProcess(String processId, JournalOperation processingUnit) {
      if (processingUnit instanceof WriteEvents) {
        return StorageFailure.create();
      } else {
        return ProcessingSuccess.getInstance();
      }
    }
  }
}</code></pre></dd>
</dl>
<p><code>tryProcess()</code> method of the <span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingPolicy.html" title="org.apache.pekko.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingPolicy.html" title="org.apache.pekko.persistence.testkit.ProcessingPolicy"><code>ProcessingPolicy</code></a></span> has two arguments: persistence id and the storage operation. </p>
<p>Event storage has the following operations:</p>
<ul>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ReadEvents.html" title="org.apache.pekko.persistence.testkit.ReadEvents"><code>ReadEvents</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ReadEvents.html" title="org.apache.pekko.persistence.testkit.ReadEvents"><code>ReadEvents</code></a></span> Read the events from the storage.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/WriteEvents.html" title="org.apache.pekko.persistence.testkit.WriteEvents"><code>WriteEvents</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/WriteEvents.html" title="org.apache.pekko.persistence.testkit.WriteEvents"><code>WriteEvents</code></a></span> Write the events to the storage.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/DeleteEvents.html" title="org.apache.pekko.persistence.testkit.DeleteEvents"><code>DeleteEvents</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/DeleteEvents.html" title="org.apache.pekko.persistence.testkit.DeleteEvents"><code>DeleteEvents</code></a></span> Delete the events from the storage.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ReadSeqNum$.html" title="org.apache.pekko.persistence.testkit.ReadSeqNum"><code>ReadSeqNum</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ReadSeqNum$.html" title="org.apache.pekko.persistence.testkit.ReadSeqNum"><code>ReadSeqNum</code></a></span> Read the highest sequence number for particular persistence id.</li>
</ul>
<p>Snapshot storage has the following operations:</p>
<ul>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ReadSnapshot.html" title="org.apache.pekko.persistence.testkit.ReadSnapshot"><code>ReadSnapshot</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ReadSnapshot.html" title="org.apache.pekko.persistence.testkit.ReadSnapshot"><code>ReadSnapshot</code></a></span> Read the snapshot from the storage.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/WriteSnapshot.html" title="org.apache.pekko.persistence.testkit.WriteSnapshot"><code>WriteSnapshot</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/WriteSnapshot.html" title="org.apache.pekko.persistence.testkit.WriteSnapshot"><code>WriteSnapshot</code></a></span> Writhe the snapshot to the storage.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/DeleteSnapshotsByCriteria.html" title="org.apache.pekko.persistence.testkit.DeleteSnapshotsByCriteria"><code>DeleteSnapshotsByCriteria</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/DeleteSnapshotsByCriteria.html" title="org.apache.pekko.persistence.testkit.DeleteSnapshotsByCriteria"><code>DeleteSnapshotsByCriteria</code></a></span> Delete snapshots in the storage by criteria.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/DeleteSnapshotByMeta.html" title="org.apache.pekko.persistence.testkit.DeleteSnapshotByMeta"><code>DeleteSnapshotByMeta</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/DeleteSnapshotByMeta.html" title="org.apache.pekko.persistence.testkit.DeleteSnapshotByMeta"><code>DeleteSnapshotByMeta</code></a></span> Delete particular snapshot from the storage by its metadata.</li>
</ul>
<p>The <code>tryProcess()</code> method must return one of the processing results:</p>
<ul>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingSuccess.html" title="org.apache.pekko.persistence.testkit.ProcessingSuccess"><code>ProcessingSuccess</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/ProcessingSuccess.html" title="org.apache.pekko.persistence.testkit.ProcessingSuccess"><code>ProcessingSuccess</code></a></span> Successful completion of the operation. All the events will be saved/read/deleted.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/StorageFailure.html" title="org.apache.pekko.persistence.testkit.StorageFailure"><code>StorageFailure</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/StorageFailure.html" title="org.apache.pekko.persistence.testkit.StorageFailure"><code>StorageFailure</code></a></span> Emulates exception from the storage.</li>
  <li><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/Reject.html" title="org.apache.pekko.persistence.testkit.Reject"><code>Reject</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/persistence/testkit/Reject.html" title="org.apache.pekko.persistence.testkit.Reject"><code>Reject</code></a></span> Emulates rejection from the storage.</li>
</ul>
<p><strong>Note</strong> that snapshot storage does not have rejections. If you return <code>Reject</code> in the <code>tryProcess()</code> of the snapshot storage policy, it will have the same effect as the <code>StorageFailure</code>.</p>
<p>Here is an example of the policy for an event storage:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L77-L101" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.pekko.persistence.testkit._

class SampleEventStoragePolicy extends EventStorage.JournalPolicies.PolicyType {

  // you can use internal state, it does not need to be thread safe
  var count = 1

  override def tryProcess(persistenceId: String, processingUnit: JournalOperation): ProcessingResult =
    if (count &lt; 10) {
      count += 1
      // check the type of operation and react with success or with reject or with failure.
      // if you return ProcessingSuccess the operation will be performed, otherwise not.
      processingUnit match {
        case ReadEvents(batch) if batch.nonEmpty =&gt; ProcessingSuccess
        case WriteEvents(batch) if batch.size &gt; 1 =&gt;
          ProcessingSuccess
        case ReadSeqNum      =&gt; StorageFailure()
        case DeleteEvents(_) =&gt; Reject()
        case _               =&gt; StorageFailure()
      }
    } else {
      ProcessingSuccess
    }

}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/TestKitExamples.java#L35-L66" target="_blank" title="Go to snippet source">source</a><code class="language-java">class SampleEventStoragePolicy implements ProcessingPolicy&lt;JournalOperation&gt; {

  // you can use internal state, it does not need to be thread safe
  int count = 1;

  @Override
  public ProcessingResult tryProcess(String processId, JournalOperation processingUnit) {
    // check the type of operation and react with success or with reject or with failure.
    // if you return ProcessingSuccess the operation will be performed, otherwise not.
    if (count &lt; 10) {
      count += 1;
      if (processingUnit instanceof ReadEvents) {
        ReadEvents read = (ReadEvents) processingUnit;
        if (read.batch().nonEmpty()) {
          ProcessingSuccess.getInstance();
        } else {
          return StorageFailure.create();
        }
      } else if (processingUnit instanceof WriteEvents) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit instanceof DeleteEvents) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit.equals(ReadSeqNum.getInstance())) {
        return Reject.create();
      }
      // you can set your own exception
      return StorageFailure.create(new RuntimeException(&quot;your exception&quot;));
    } else {
      return ProcessingSuccess.getInstance();
    }
  }
}</code></pre></dd>
</dl>
<p>Here is an example of the policy for a snapshot storage:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/TestKitExamples.scala#L105-L128" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class SampleSnapshotStoragePolicy extends SnapshotStorage.SnapshotPolicies.PolicyType {

  // you can use internal state, it does not need to be thread safe
  var count = 1

  override def tryProcess(persistenceId: String, processingUnit: SnapshotOperation): ProcessingResult =
    if (count &lt; 10) {
      count += 1
      // check the type of operation and react with success or with reject or with failure.
      // if you return ProcessingSuccess the operation will be performed, otherwise not.
      processingUnit match {
        case ReadSnapshot(_, payload) if payload.nonEmpty =&gt;
          ProcessingSuccess
        case WriteSnapshot(meta, payload) if meta.sequenceNr &gt; 10 =&gt;
          ProcessingSuccess
        case DeleteSnapshotsByCriteria(_) =&gt; StorageFailure()
        case DeleteSnapshotByMeta(meta) if meta.sequenceNr &lt; 10 =&gt;
          ProcessingSuccess
        case _ =&gt; StorageFailure()
      }
    } else {
      ProcessingSuccess
    }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/TestKitExamples.java#L70-L101" target="_blank" title="Go to snippet source">source</a><code class="language-java">class SnapshotStoragePolicy implements ProcessingPolicy&lt;SnapshotOperation&gt; {

  // you can use internal state, it doesn&#39;t need to be thread safe
  int count = 1;

  @Override
  public ProcessingResult tryProcess(String processId, SnapshotOperation processingUnit) {
    // check the type of operation and react with success or with failure.
    // if you return ProcessingSuccess the operation will be performed, otherwise not.
    if (count &lt; 10) {
      count += 1;
      if (processingUnit instanceof ReadSnapshot) {
        ReadSnapshot read = (ReadSnapshot) processingUnit;
        if (read.getSnapshot().isPresent()) {
          ProcessingSuccess.getInstance();
        } else {
          return StorageFailure.create();
        }
      } else if (processingUnit instanceof WriteSnapshot) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit instanceof DeleteSnapshotsByCriteria) {
        return ProcessingSuccess.getInstance();
      } else if (processingUnit instanceof DeleteSnapshotByMeta) {
        return ProcessingSuccess.getInstance();
      }
      // you can set your own exception
      return StorageFailure.create(new RuntimeException(&quot;your exception&quot;));
    } else {
      return ProcessingSuccess.getInstance();
    }
  }
}</code></pre></dd>
</dl>
<h3><a href="#configuration-of-persistence-testkit" name="configuration-of-persistence-testkit" class="anchor"><span class="anchor-link"></span></a>Configuration of Persistence TestKit</h3>
<p>There are several configuration properties for persistence testkit, please refer to the <a href="../general/configuration-reference.html#config-pekko-persistence-testkit">reference configuration</a></p>
<h2><a href="#integration-testing" name="integration-testing" class="anchor"><span class="anchor-link"></span></a>Integration testing</h2>
<p><code>EventSourcedBehavior</code> actors can be tested with the <a href="testing-async.html">ActorTestKit</a> together with other actors. The in-memory journal and snapshot storage from the <a href="persistence-testing.html#persistence-testkit">Persistence TestKit</a> can be used also for integration style testing of a single <code>ActorSystem</code>, for example when using Cluster Sharding with a single Cluster node.</p>
<p>For tests that involve more than one Cluster node you have to use another journal and snapshot store. While it&rsquo;s possible to use the <a href="../persistence-plugins.html#persistence-plugin-proxy">Persistence Plugin Proxy</a> it&rsquo;s often better and more realistic to use a real database.</p>
<p>The <a href="../project/examples.html#cqrs">CQRS example</a> includes tests that are using Pekko Persistence Cassandra.</p>
<h3><a href="#plugin-initialization" name="plugin-initialization" class="anchor"><span class="anchor-link"></span></a>Plugin initialization</h3>
<p>Some Persistence plugins create tables automatically, but has the limitation that it can&rsquo;t be done concurrently from several ActorSystems. That can be a problem if the test creates a Cluster and all nodes tries to initialize the plugins at the same time. To coordinate initialization you can use the <code>PersistenceInit</code> utility.</p>
<p><code>PersistenceInit</code> is part of <code>pekko-persistence-testkit</code> and you need to add the dependency to your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val PekkoVersion = "2.6.20+81-523134c3+20230202-1514-SNAPSHOT"
libraryDependencies += "org.apache.pekko" %% "pekko-persistence-testkit" % PekkoVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
      &lt;artifactId&gt;pekko-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.6.20+81-523134c3+20230202-1514-SNAPSHOT&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
    &lt;artifactId&gt;pekko-persistence-testkit_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("org.apache.pekko:pekko-bom_${versions.ScalaBinary}:2.6.20+81-523134c3+20230202-1514-SNAPSHOT")

  implementation "org.apache.pekko:pekko-persistence-testkit_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/persistence/testkit/PersistenceInitSpec.scala#L23-L28" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.pekko.persistence.testkit.scaladsl.PersistenceInit

import scala.concurrent.Await
import scala.concurrent.Future
import scala.concurrent.duration._

val timeout = 5.seconds
val done: Future[Done] = PersistenceInit.initializeDefaultPlugins(system, timeout)
Await.result(done, timeout)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/persistence/testkit/PersistenceInitTest.java#L26-L32" target="_blank" title="Go to snippet source">source</a><code class="language-java">import org.apache.pekko.persistence.testkit.javadsl.PersistenceInit;
import org.apache.pekko.Done;

import java.time.Duration;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeUnit;

Duration timeout = Duration.ofSeconds(5);
CompletionStage&lt;Done&gt; done =
    PersistenceInit.initializeDefaultPlugins(testKit.system(), timeout);
done.toCompletableFuture().get(timeout.getSeconds(), TimeUnit.SECONDS);</code></pre></dd>
</dl>
</div>
<div>
<a href="https://github.com/apache/incubator-pekko/tree/main/docs/src/main/paradox/typed/persistence-testing.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.6.20+81-523134c3+20230202-1514*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../typed/persistence-snapshot.html" title="Snapshotting" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Snapshotting
</span>
</div>
</a>
<a href="../typed/persistence-fsm.html" title="EventSourced behaviors as finite state machines" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
EventSourced behaviors as finite state machines
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright Â© 2023 The Apache Software Foundation, Licensed under the Apache License, Version 2.0
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../assets/js/groups.js"></script>
</body>
</html>
