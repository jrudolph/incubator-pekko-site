<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Cluster Specification · Apache Pekko</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Apache Pekko" class="md-header-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Apache Pekko
</span>
<span class="md-header-nav__topic">
Cluster Specification
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Apache Pekko" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
<a href="../index.html" title="Apache Pekko">
Apache Pekko
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../downloads.html" class="page">Downloads</a></li>
  <li><a href="../documentation.html" class="page">Documentation</a>
  <ul>
    <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
    <li><a href="../general/index.html" class="page">General Concepts</a></li>
    <li><a href="../typed/index.html" class="page">Actors</a></li>
    <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
    <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
    <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
    <li><a href="../stream/index.html" class="page">Streams</a></li>
    <li><a href="../discovery/index.html" class="page">Discovery</a></li>
    <li><a href="../index-utilities.html" class="page">Utilities</a></li>
    <li><a href="../common/other-modules.html" class="page">Other Apache Pekko modules</a></li>
    <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
    <li><a href="../project/index.html" class="page">Project Information</a></li>
    <li><a href="../index-classic.html" class="page">Pekko Classic</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../typed/cluster-concepts.html#cluster-specification" class="header">Cluster Specification</a>
  <ul>
    <li><a href="../typed/cluster-concepts.html#introduction" class="header">Introduction</a></li>
    <li><a href="../typed/cluster-concepts.html#terms" class="header">Terms</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.6.20+81-523134c3+20230202-1514*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../typed/cluster-concepts.html#cluster-specification" class="header">Cluster Specification</a>
  <ul>
    <li><a href="../typed/cluster-concepts.html#introduction" class="header">Introduction</a></li>
    <li><a href="../typed/cluster-concepts.html#terms" class="header">Terms</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#cluster-specification" name="cluster-specification" class="anchor"><span class="anchor-link"></span></a>Cluster Specification</h1>
<p>This document describes the design concepts of Pekko Cluster. For the guide on using Pekko Cluster please see either</p>
<ul>
  <li><a href="cluster.html">Cluster Usage</a></li>
  <li><a href="../cluster-usage.html">Cluster Usage with classic Pekko APIs</a></li>
  <li><a href="cluster-membership.html">Cluster Membership Service</a></li>
</ul>
<h2><a href="#introduction" name="introduction" class="anchor"><span class="anchor-link"></span></a>Introduction</h2>
<p>Pekko Cluster provides a fault-tolerant decentralized peer-to-peer based <a href="cluster-membership.html#cluster-membership-service">Cluster Membership Service</a> with no single point of failure or single point of bottleneck. It does this using <a href="cluster-concepts.html#gossip">gossip</a> protocols and an automatic <a href="#failure-detector">failure detector</a>.</p>
<p>Pekko Cluster allows for building distributed applications, where one application or service spans multiple nodes (in practice multiple <span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/actor/typed/ActorSystem.html" title="org.apache.pekko.actor.typed.ActorSystem"><code>ActorSystem</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/actor/typed/ActorSystem.html" title="org.apache.pekko.actor.typed.ActorSystem"><code>ActorSystem</code></a></span>s). </p>
<h2><a href="#terms" name="terms" class="anchor"><span class="anchor-link"></span></a>Terms</h2>
<dl>
  <dt><strong>node</strong></dt>
  <dd>A logical member of a cluster. There could be multiple nodes on a physical machine. Defined by a <em>hostname:port:uid</em> tuple.</dd>
  <dt><strong>cluster</strong></dt>
  <dd>A set of nodes joined together through the <a href="cluster-membership.html#cluster-membership-service">Cluster Membership Service</a>.</dd>
  <dt><strong>leader</strong></dt>
  <dd>A single node in the cluster that acts as the leader. Managing cluster convergence and membership state transitions.</dd>
</dl>
<h3><a href="#gossip" name="gossip" class="anchor"><span class="anchor-link"></span></a>Gossip</h3>
<p>The cluster membership used in Pekko is based on Amazon&rsquo;s <a href="https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf">Dynamo</a> system and particularly the approach taken in Basho&rsquo;s&rsquo; <a href="https://en.wikipedia.org/wiki/Riak">Riak</a> distributed database. Cluster membership is communicated using a <a href="https://en.wikipedia.org/wiki/Gossip_protocol">Gossip Protocol</a>, where the current state of the cluster is gossiped randomly through the cluster, with preference to members that have not seen the latest version.</p>
<h4><a href="#vector-clocks" name="vector-clocks" class="anchor"><span class="anchor-link"></span></a>Vector Clocks</h4>
<p><a href="https://en.wikipedia.org/wiki/Vector_clock">Vector clocks</a> are a type of data structure and algorithm for generating a partial ordering of events in a distributed system and detecting causality violations.</p>
<p>We use vector clocks to reconcile and merge differences in cluster state during gossiping. A vector clock is a set of (node, counter) pairs. Each update to the cluster state has an accompanying update to the vector clock.</p>
<h4><a href="#gossip-convergence" name="gossip-convergence" class="anchor"><span class="anchor-link"></span></a>Gossip Convergence</h4>
<p>Information about the cluster converges locally at a node at certain points in time. This is when a node can prove that the cluster state it is observing has been observed by all other nodes in the cluster. Convergence is implemented by passing a set of nodes that have seen current state version during gossip. This information is referred to as the seen set in the gossip overview. When all nodes are included in the seen set there is convergence.</p>
<p>Gossip convergence cannot occur while any nodes are <code>unreachable</code>. The nodes need to become <code>reachable</code> again, or moved to the <code>down</code> and <code>removed</code> states (see the <a href="cluster-membership.html#membership-lifecycle">Cluster Membership Lifecycle</a> section). This only blocks the leader from performing its cluster membership management and does not influence the application running on top of the cluster. For example this means that during a network partition it is not possible to add more nodes to the cluster. The nodes can join, but they will not be moved to the <code>up</code> state until the partition has healed or the unreachable nodes have been downed.</p>
<h4><a href="#failure-detector" name="failure-detector" class="anchor"><span class="anchor-link"></span></a>Failure Detector</h4>
<p>The failure detector in Pekko Cluster is responsible for trying to detect if a node is <code>unreachable</code> from the rest of the cluster. For this we are using the <a href="failure-detector.html">Phi Accrual Failure Detector</a> implementation. To be able to survive sudden abnormalities, such as garbage collection pauses and transient network failures the failure detector is easily <a href="cluster.html#using-the-failure-detector">configurable</a> for tuning to your environments and needs.</p>
<p>In a cluster each node is monitored by a few (default maximum 5) other nodes. The nodes to monitor are selected from neighbors in a hashed ordered node ring. This is to increase the likelihood to monitor across racks and data centers, but the order is the same on all nodes, which ensures full coverage.</p>
<p>When any node is detected to be <code>unreachable</code> this data is spread to the rest of the cluster through the <a href="cluster-concepts.html#gossip">gossip</a>. In other words, only one node needs to mark a node <code>unreachable</code> to have the rest of the cluster mark that node <code>unreachable</code>.</p>
<p>The failure detector will also detect if the node becomes <code>reachable</code> again. When all nodes that monitored the <code>unreachable</code> node detect it as <code>reachable</code> again the cluster, after gossip dissemination, will consider it as <code>reachable</code>.</p>
<a id="quarantined"></a>
<p>If system messages cannot be delivered to a node it will be quarantined and then it cannot come back from <code>unreachable</code>. This can happen if the there are too many unacknowledged system messages (e.g. watch, Terminated, remote actor deployment, failures of actors supervised by remote parent). Then the node needs to be moved to the <code>down</code> or <code>removed</code> states (see <a href="cluster-membership.html#membership-lifecycle">Cluster Membership Lifecycle</a>) and the actor system of the quarantined node must be restarted before it can join the cluster again.</p>
<p>See the following for more details:</p>
<ul>
  <li><a href="failure-detector.html">Phi Accrual Failure Detector</a> implementation</li>
  <li><a href="cluster.html#using-the-failure-detector">Using the Failure Detector</a></li>
</ul>
<h4><a href="#leader" name="leader" class="anchor"><span class="anchor-link"></span></a>Leader</h4>
<p>After gossip convergence a <code>leader</code> for the cluster can be determined. There is no <code>leader</code> election process, the <code>leader</code> can always be recognised deterministically by any node whenever there is gossip convergence. The leader is only a role, any node can be the leader and it can change between convergence rounds. The <code>leader</code> is the first node in sorted order that is able to take the leadership role, where the preferred member states for a <code>leader</code> are <code>up</code> and <code>leaving</code> (see the <a href="cluster-membership.html#membership-lifecycle">Cluster Membership Lifecycle</a> for more information about member states).</p>
<p>The role of the <code>leader</code> is to shift members in and out of the cluster, changing <code>joining</code> members to the <code>up</code> state or <code>exiting</code> members to the <code>removed</code> state. Currently <code>leader</code> actions are only triggered by receiving a new cluster state with gossip convergence.</p>
<h4><a href="#seed-nodes" name="seed-nodes" class="anchor"><span class="anchor-link"></span></a>Seed Nodes</h4>
<p>The seed nodes are contact points for new nodes joining the cluster. When a new node is started it sends a message to all seed nodes and then sends a join command to the seed node that answers first.</p>
<p>The seed nodes configuration value does not have any influence on the running cluster itself, it is only relevant for new nodes joining the cluster as it helps them to find contact points to send the join command to; a new member can send this command to any current member of the cluster, not only to the seed nodes.</p>
<h4><a href="#gossip-protocol" name="gossip-protocol" class="anchor"><span class="anchor-link"></span></a>Gossip Protocol</h4>
<p>A variation of <em>push-pull gossip</em> is used to reduce the amount of gossip information sent around the cluster. In push-pull gossip a digest is sent representing current versions but not actual values; the recipient of the gossip can then send back any values for which it has newer versions and also request values for which it has outdated versions. Pekko uses a single shared state with a vector clock for versioning, so the variant of push-pull gossip used in Pekko makes use of this version to only push the actual state as needed.</p>
<p>Periodically, the default is every 1 second, each node chooses another random node to initiate a round of gossip with. If less than ½ of the nodes resides in the seen set (have seen the new state) then the cluster gossips 3 times instead of once every second. This adjusted gossip interval is a way to speed up the convergence process in the early dissemination phase after a state change.</p>
<p>The choice of node to gossip with is random but biased towards nodes that might not have seen the current state version. During each round of gossip exchange, when convergence is not yet reached, a node uses a very high probability (which is configurable) to gossip with another node which is not part of the seen set, i.e. which is likely to have an older version of the state. Otherwise it gossips with any random live node.</p>
<p>This biased selection is a way to speed up the convergence process in the late dissemination phase after a state change.</p>
<p>For clusters larger than 400 nodes (configurable, and suggested by empirical evidence) the 0.8 probability is gradually reduced to avoid overwhelming single stragglers with too many concurrent gossip requests. The gossip receiver also has a mechanism to protect itself from too many simultaneous gossip messages by dropping messages that have been enqueued in the mailbox for too long of a time.</p>
<p>While the cluster is in a converged state the gossiper only sends a small gossip status message containing the gossip version to the chosen node. As soon as there is a change to the cluster (meaning non-convergence) then it goes back to biased gossip again.</p>
<p>The recipient of the gossip state or the gossip status can use the gossip version (vector clock) to determine whether:</p>
<ol>
  <li>it has a newer version of the gossip state, in which case it sends that back to the gossiper</li>
  <li>it has an outdated version of the state, in which case the recipient requests the current state from the gossiper by sending back its version of the gossip state</li>
  <li>it has conflicting gossip versions, in which case the different versions are merged and sent back</li>
</ol>
<p>If the recipient and the gossip have the same version then the gossip state is not sent or requested.</p>
<p>The periodic nature of the gossip has a nice batching effect of state changes, e.g. joining several nodes quickly after each other to one node will result in only one state change to be spread to other members in the cluster.</p>
<p>The gossip messages are serialized with <a href="https://github.com/protocolbuffers/protobuf">protobuf</a> and also gzipped to reduce payload size.</p>
</div>
<div>
<a href="https://github.com/apache/incubator-pekko/tree/main/docs/src/main/paradox/typed/cluster-concepts.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.6.20+81-523134c3+20230202-1514*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../typed/cluster.html" title="Cluster Usage" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Cluster Usage
</span>
</div>
</a>
<a href="../typed/cluster-membership.html" title="Cluster Membership Service" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Cluster Membership Service
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright © 2023 The Apache Software Foundation, Licensed under the Apache License, Version 2.0
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../assets/js/groups.js"></script>
</body>
</html>
