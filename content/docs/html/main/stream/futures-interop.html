<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Futures interop Â· Apache Pekko</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Apache Pekko" class="md-header-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Apache Pekko
</span>
<span class="md-header-nav__topic">
Futures interop
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Apache Pekko" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
<a href="../index.html" title="Apache Pekko">
Apache Pekko
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../downloads.html" class="page">Downloads</a></li>
  <li><a href="../documentation.html" class="page">Documentation</a>
  <ul>
    <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
    <li><a href="../general/index.html" class="page">General Concepts</a></li>
    <li><a href="../typed/index.html" class="page">Actors</a></li>
    <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
    <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
    <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
    <li><a href="../stream/index.html" class="page">Streams</a></li>
    <li><a href="../discovery/index.html" class="page">Discovery</a></li>
    <li><a href="../index-utilities.html" class="page">Utilities</a></li>
    <li><a href="../common/other-modules.html" class="page">Other Apache Pekko modules</a></li>
    <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
    <li><a href="../project/index.html" class="page">Project Information</a></li>
    <li><a href="../index-classic.html" class="page">Pekko Classic</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../stream/futures-interop.html#futures-interop" class="header">Futures interop</a>
  <ul>
    <li><a href="../stream/futures-interop.html#dependency" class="header">Dependency</a></li>
    <li><a href="../stream/futures-interop.html#overview" class="header">Overview</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.6.20+81-523134c3+20230202-1514*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../stream/futures-interop.html#futures-interop" class="header">Futures interop</a>
  <ul>
    <li><a href="../stream/futures-interop.html#dependency" class="header">Dependency</a></li>
    <li><a href="../stream/futures-interop.html#overview" class="header">Overview</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#futures-interop" name="futures-interop" class="anchor"><span class="anchor-link"></span></a>Futures interop</h1>
<h2><a href="#dependency" name="dependency" class="anchor"><span class="anchor-link"></span></a>Dependency</h2>
<p>To use Pekko Streams, add the module to your project:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">val PekkoVersion = "2.6.20+81-523134c3+20230202-1514-SNAPSHOT"
libraryDependencies += "org.apache.pekko" %% "pekko-stream" % PekkoVersion</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;properties&gt;
  &lt;scala.binary.version&gt;2.13&lt;/scala.binary.version&gt;
&lt;/properties&gt;
&lt;dependencyManagement&gt;
  &lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
      &lt;artifactId&gt;pekko-bom_${scala.binary.version}&lt;/artifactId&gt;
      &lt;version&gt;2.6.20+81-523134c3+20230202-1514-SNAPSHOT&lt;/version&gt;
      &lt;type&gt;pom&lt;/type&gt;
      &lt;scope&gt;import&lt;/scope&gt;
    &lt;/dependency&gt
  &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt
  &lt;dependency&gt;
    &lt;groupId&gt;org.apache.pekko&lt;/groupId&gt;
    &lt;artifactId&gt;pekko-stream_${scala.binary.version}&lt;/artifactId&gt;
  &lt;/dependency&gt
&lt;/dependencies&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">def versions = [
  ScalaBinary: "2.13"
]
dependencies {
  implementation platform("org.apache.pekko:pekko-bom_${versions.ScalaBinary}:2.6.20+81-523134c3+20230202-1514-SNAPSHOT")

  implementation "org.apache.pekko:pekko-stream_${versions.ScalaBinary}"
}</code></pre></dd></dl>
<h2><a href="#overview" name="overview" class="anchor"><span class="anchor-link"></span></a>Overview</h2>
<p>Stream transformations and side effects involving external non-stream based services can be performed with <code>mapAsync</code> or <code>mapAsyncUnordered</code>.</p>
<p>For example, sending emails to the authors of selected tweets using an external email service:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L77-L83" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def send(email: Email): Future[Unit] = {
  // ...
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L198-L204" target="_blank" title="Go to snippet source">source</a><code class="language-java">public CompletionStage&lt;Email&gt; send(Email email) {
  // ...
}</code></pre></dd>
</dl>
<p>We start with the tweet stream of authors:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L170-L171" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val authors: Source[Author, NotUsed] =
  tweets.filter(_.hashtags.contains(pekkoTag)).map(_.author)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L446-L448" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Source&lt;Author, NotUsed&gt; authors =
    tweets.filter(t -&gt; t.hashtags().contains(PEKKO)).map(t -&gt; t.author);
</code></pre></dd>
</dl>
<p>Assume that we can look up their email address using:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L55" target="_blank" title="Go to snippet source">source</a><code class="language-scala">def lookupEmail(handle: String): Future[Option[String]] =</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L85" target="_blank" title="Go to snippet source">source</a><code class="language-java">public CompletionStage&lt;Optional&lt;String&gt;&gt; lookupEmail(String handle)</code></pre></dd>
</dl>
<p>Transforming the stream of authors to a stream of email addresses by using the <code>lookupEmail</code> service can be done with <code>mapAsync</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L175-L178" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val emailAddresses: Source[String, NotUsed] =
  authors.mapAsync(4)(author =&gt; addressSystem.lookupEmail(author.handle)).collect {
    case Some(emailAddress) =&gt; emailAddress
  }</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L452-L457" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Source&lt;String, NotUsed&gt; emailAddresses =
    authors
        .mapAsync(4, author -&gt; addressSystem.lookupEmail(author.handle))
        .filter(o -&gt; o.isPresent())
        .map(o -&gt; o.get());
</code></pre></dd>
</dl>
<p>Finally, sending the emails:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L182-L189" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val sendEmails: RunnableGraph[NotUsed] =
  emailAddresses
    .mapAsync(4)(address =&gt; {
      emailServer.send(Email(to = address, title = &quot;pekko&quot;, body = &quot;I like your tweet&quot;))
    })
    .to(Sink.ignore)

sendEmails.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L461-L468" target="_blank" title="Go to snippet source">source</a><code class="language-java">final RunnableGraph&lt;NotUsed&gt; sendEmails =
    emailAddresses
        .mapAsync(
            4,
            address -&gt; emailServer.send(new Email(address, &quot;PEKKO&quot;, &quot;I like your tweet&quot;)))
        .to(Sink.ignore());

sendEmails.run(system);</code></pre></dd>
</dl>
<p><code>mapAsync</code> is applying the given function that is calling out to the external service to each of the elements as they pass through this processing step. The function returns a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span> and the value of that future will be emitted downstream. The number of Futures that shall run in parallel is given as the first argument to <code>mapAsync</code>. These Futures may complete in any order, but the elements that are emitted downstream are in the same order as received from upstream.</p>
<p>That means that back-pressure works as expected. For example if the <code>emailServer.send</code> is the bottleneck it will limit the rate at which incoming tweets are retrieved and email addresses looked up.</p>
<p>The final piece of this pipeline is to generate the demand that pulls the tweet authors information through the emailing pipeline: we attach a <code>Sink.ignore</code> which makes it all run. If our email process would return some interesting data for further transformation then we would not ignore it but send that result stream onwards for further processing or storage.</p>
<p>Note that <code>mapAsync</code> preserves the order of the stream elements. In this example the order is not important and then we can use the more efficient <code>mapAsyncUnordered</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L287-L302" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val authors: Source[Author, NotUsed] =
  tweets.filter(_.hashtags.contains(pekkoTag)).map(_.author)

val emailAddresses: Source[String, NotUsed] =
  authors.mapAsyncUnordered(4)(author =&gt; addressSystem.lookupEmail(author.handle)).collect {
    case Some(emailAddress) =&gt; emailAddress
  }

val sendEmails: RunnableGraph[NotUsed] =
  emailAddresses
    .mapAsyncUnordered(4)(address =&gt; {
      emailServer.send(Email(to = address, title = &quot;Pekko&quot;, body = &quot;I like your tweet&quot;))
    })
    .to(Sink.ignore)

sendEmails.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L515-L531" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Source&lt;Author, NotUsed&gt; authors =
    tweets.filter(t -&gt; t.hashtags().contains(PEKKO)).map(t -&gt; t.author);

final Source&lt;String, NotUsed&gt; emailAddresses =
    authors
        .mapAsyncUnordered(4, author -&gt; addressSystem.lookupEmail(author.handle))
        .filter(o -&gt; o.isPresent())
        .map(o -&gt; o.get());

final RunnableGraph&lt;NotUsed&gt; sendEmails =
    emailAddresses
        .mapAsyncUnordered(
            4,
            address -&gt; emailServer.send(new Email(address, &quot;Pekko&quot;, &quot;I like your tweet&quot;)))
        .to(Sink.ignore());

sendEmails.run(system);</code></pre></dd>
</dl>
<p>In the above example the services conveniently returned a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span> of the result. If that is not the case you need to wrap the call in a <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span>. If the service call involves blocking you must also make sure that you run it on a dedicated execution context, to avoid starvation and disturbance of other tasks in the system.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L329-L340" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val blockingExecutionContext = system.dispatchers.lookup(&quot;blocking-dispatcher&quot;)

val sendTextMessages: RunnableGraph[NotUsed] =
  phoneNumbers
    .mapAsync(4)(phoneNo =&gt; {
      Future {
        smsServer.send(TextMessage(to = phoneNo, body = &quot;I like your tweet&quot;))
      }(blockingExecutionContext)
    })
    .to(Sink.ignore)

sendTextMessages.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L555-L567" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Executor blockingEc = system.dispatchers().lookup(&quot;blocking-dispatcher&quot;);

final RunnableGraph&lt;NotUsed&gt; sendTextMessages =
    phoneNumbers
        .mapAsync(
            4,
            phoneNo -&gt;
                CompletableFuture.supplyAsync(
                    () -&gt; smsServer.send(new TextMessage(phoneNo, &quot;I like your tweet&quot;)),
                    blockingEc))
        .to(Sink.ignore());

sendTextMessages.run(system);</code></pre></dd>
</dl>
<p>The configuration of the <code>&quot;blocking-dispatcher&quot;</code> may look something like:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L41-L47" target="_blank" title="Go to snippet source">source</a><code class="language-scala">blocking-dispatcher {
  executor = &quot;thread-pool-executor&quot;
  thread-pool-executor {
    core-pool-size-min    = 10
    core-pool-size-max    = 10
  }
}</code></pre>
<p>An alternative for blocking calls is to perform them in a <code>map</code> operation, still using a dedicated dispatcher for that operation.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L367-L375" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val send = Flow[String]
  .map { phoneNo =&gt;
    smsServer.send(TextMessage(to = phoneNo, body = &quot;I like your tweet&quot;))
  }
  .withAttributes(ActorAttributes.dispatcher(&quot;blocking-dispatcher&quot;))
val sendTextMessages: RunnableGraph[NotUsed] =
  phoneNumbers.via(send).to(Sink.ignore)

sendTextMessages.run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L603-L609" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Flow&lt;String, Boolean, NotUsed&gt; send =
    Flow.of(String.class)
        .map(phoneNo -&gt; smsServer.send(new TextMessage(phoneNo, &quot;I like your tweet&quot;)))
        .withAttributes(ActorAttributes.dispatcher(&quot;blocking-dispatcher&quot;));
final RunnableGraph&lt;?&gt; sendTextMessages = phoneNumbers.via(send).to(Sink.ignore());

sendTextMessages.run(system);</code></pre></dd>
</dl>
<p>However, that is not exactly the same as <code>mapAsync</code>, since the <code>mapAsync</code> may run several calls concurrently, but <code>map</code> performs them one at a time.</p>
<p>For a service that is exposed as an actor, or if an actor is used as a gateway in front of an external service, you can use <code>ask</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L392-L398" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import org.apache.pekko.pattern.ask

val PekkoTweets: Source[Tweet, NotUsed] = tweets.filter(_.hashtags.contains(pekkoTag))

implicit val timeout: Timeout = 3.seconds
val saveTweets: RunnableGraph[NotUsed] =
  PekkoTweets.mapAsync(4)(tweet =&gt; database ? Save(tweet)).to(Sink.ignore)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L634-L639" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Source&lt;Tweet, NotUsed&gt; pekkoTweets = tweets.filter(t -&gt; t.hashtags().contains(PEKKO));

final RunnableGraph&lt;NotUsed&gt; saveTweets =
    pekkoTweets
        .mapAsync(4, tweet -&gt; ask(database, new Save(tweet), Duration.ofMillis(300L)))
        .to(Sink.ignore());</code></pre></dd>
</dl>
<p>Note that if the <code>ask</code> is not completed within the given timeout the stream is completed with failure. If that is not desired outcome you can use <code>recover</code> on the <code>ask</code> <span class="group-scala"><code>Future</code></span><span class="group-java"><code>CompletionStage</code></span>.</p>
<h3><a href="#illustrating-ordering-and-parallelism" name="illustrating-ordering-and-parallelism" class="anchor"><span class="anchor-link"></span></a>Illustrating ordering and parallelism</h3>
<p>Let us look at another example to get a better understanding of the ordering and parallelism characteristics of <code>mapAsync</code> and <code>mapAsyncUnordered</code>.</p>
<p>Several <code>mapAsync</code> and <code>mapAsyncUnordered</code> futures may run concurrently. The number of concurrent futures are limited by the downstream demand. For example, if 5 elements have been requested by downstream there will be at most 5 futures in progress.</p>
<p><code>mapAsync</code> emits the future results in the same order as the input elements were received. That means that completed results are only emitted downstream when earlier results have been completed and emitted. One slow call will thereby delay the results of all successive calls, even though they are completed before the slow call.</p>
<p><code>mapAsyncUnordered</code> emits the future results as soon as they are completed, i.e. it is possible that the elements are not emitted downstream in the same order as received from upstream. One slow call will thereby not delay the results of faster successive calls as long as there is downstream demand of several elements.</p>
<p>Here is a fictive service that we can use to illustrate these aspects.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L110-L128" target="_blank" title="Go to snippet source">source</a><code class="language-scala">class SometimesSlowService(implicit ec: ExecutionContext) {

  private val runningCount = new AtomicInteger

  def convert(s: String): Future[String] = {
    println(s&quot;running: $s (${runningCount.incrementAndGet()})&quot;)
    Future {
      if (s.nonEmpty &amp;&amp; s.head.isLower)
        Thread.sleep(500)
      else
        Thread.sleep(20)
      println(s&quot;completed: $s (${runningCount.decrementAndGet()})&quot;)
      s.toUpperCase
    }
  }
}</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L284-L312" target="_blank" title="Go to snippet source">source</a><code class="language-java">static class SometimesSlowService {
  private final Executor ec;

  public SometimesSlowService(Executor ec) {
    this.ec = ec;
  }

  private final AtomicInteger runningCount = new AtomicInteger();

  public CompletionStage&lt;String&gt; convert(String s) {
    System.out.println(&quot;running: &quot; + s + &quot;(&quot; + runningCount.incrementAndGet() + &quot;)&quot;);
    return CompletableFuture.supplyAsync(
        () -&gt; {
          if (!s.isEmpty() &amp;&amp; Character.isLowerCase(s.charAt(0)))
            try {
              Thread.sleep(500);
            } catch (InterruptedException e) {
            }
          else
            try {
              Thread.sleep(20);
            } catch (InterruptedException e) {
            }
          System.out.println(&quot;completed: &quot; + s + &quot;(&quot; + runningCount.decrementAndGet() + &quot;)&quot;);
          return s.toUpperCase();
        },
        ec);
  }
}</code></pre></dd>
</dl>
<p>Elements starting with a lower case character are simulated to take longer time to process.</p>
<p>Here is how we can use it with <code>mapAsync</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L420-L428" target="_blank" title="Go to snippet source">source</a><code class="language-scala">implicit val blockingExecutionContext = system.dispatchers.lookup(&quot;blocking-dispatcher&quot;)
val service = new SometimesSlowService

Source(List(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
  .map(elem =&gt; { println(s&quot;before: $elem&quot;); elem })
  .mapAsync(4)(service.convert)
  .to(Sink.foreach(elem =&gt; println(s&quot;after: $elem&quot;)))
  .withAttributes(Attributes.inputBuffer(initial = 4, max = 4))
  .run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L675-L687" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Executor blockingEc = system.dispatchers().lookup(&quot;blocking-dispatcher&quot;);
final SometimesSlowService service = new SometimesSlowService(blockingEc);

Source.from(Arrays.asList(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
    .map(
        elem -&gt; {
          System.out.println(&quot;before: &quot; + elem);
          return elem;
        })
    .mapAsync(4, service::convert)
    .to(Sink.foreach(elem -&gt; System.out.println(&quot;after: &quot; + elem)))
    .withAttributes(Attributes.inputBuffer(4, 4))
    .run(system);</code></pre></dd>
</dl>
<p>The output may look like this:</p>
<pre><code>before: a
before: B
before: C
before: D
running: a (1)
running: B (2)
before: e
running: C (3)
before: F
running: D (4)
before: g
before: H
completed: C (3)
completed: B (2)
completed: D (1)
completed: a (0)
after: A
after: B
running: e (1)
after: C
after: D
running: F (2)
before: i
before: J
running: g (3)
running: H (4)
completed: H (2)
completed: F (3)
completed: e (1)
completed: g (0)
after: E
after: F
running: i (1)
after: G
after: H
running: J (2)
completed: J (1)
completed: i (0)
after: I
after: J
</code></pre>
<p>Note that <code>after</code> lines are in the same order as the <code>before</code> lines even though elements are <code>completed</code> in a different order. For example <code>H</code> is <code>completed</code> before <code>g</code>, but still emitted afterwards.</p>
<p>The numbers in parentheses illustrate how many calls that are in progress at the same time. Here the downstream demand and thereby the number of concurrent calls are limited by the buffer size (4) set with an attribute.</p>
<p>Here is how we can use the same service with <code>mapAsyncUnordered</code>:</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/IntegrationDocSpec.scala#L451-L459" target="_blank" title="Go to snippet source">source</a><code class="language-scala">implicit val blockingExecutionContext = system.dispatchers.lookup(&quot;blocking-dispatcher&quot;)
val service = new SometimesSlowService

Source(List(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
  .map(elem =&gt; { println(s&quot;before: $elem&quot;); elem })
  .mapAsyncUnordered(4)(service.convert)
  .to(Sink.foreach(elem =&gt; println(s&quot;after: $elem&quot;)))
  .withAttributes(Attributes.inputBuffer(initial = 4, max = 4))
  .run()</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/IntegrationDocTest.java#L723-L735" target="_blank" title="Go to snippet source">source</a><code class="language-java">final Executor blockingEc = system.dispatchers().lookup(&quot;blocking-dispatcher&quot;);
final SometimesSlowService service = new SometimesSlowService(blockingEc);

Source.from(Arrays.asList(&quot;a&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;e&quot;, &quot;F&quot;, &quot;g&quot;, &quot;H&quot;, &quot;i&quot;, &quot;J&quot;))
    .map(
        elem -&gt; {
          System.out.println(&quot;before: &quot; + elem);
          return elem;
        })
    .mapAsyncUnordered(4, service::convert)
    .to(Sink.foreach(elem -&gt; System.out.println(&quot;after: &quot; + elem)))
    .withAttributes(Attributes.inputBuffer(4, 4))
    .run(system);</code></pre></dd>
</dl>
<p>The output may look like this:</p>
<pre><code>before: a
before: B
before: C
before: D
running: a (1)
running: B (2)
before: e
running: C (3)
before: F
running: D (4)
before: g
before: H
completed: B (3)
completed: C (1)
completed: D (2)
after: B
after: D
running: e (2)
after: C
running: F (3)
before: i
before: J
completed: F (2)
after: F
running: g (3)
running: H (4)
completed: H (3)
after: H
completed: a (2)
after: A
running: i (3)
running: J (4)
completed: J (3)
after: J
completed: e (2)
after: E
completed: g (1)
after: G
completed: i (0)
after: I
</code></pre>
<p>Note that <code>after</code> lines are not in the same order as the <code>before</code> lines. For example <code>H</code> overtakes the slow <code>G</code>.</p>
<p>The numbers in parentheses illustrate how many calls that are in progress at the same time. Here the downstream demand and thereby the number of concurrent calls are limited by the buffer size (4) set with an attribute.</p>
</div>
<div>
<a href="https://github.com/apache/incubator-pekko/tree/main/docs/src/main/paradox/stream/futures-interop.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.6.20+81-523134c3+20230202-1514*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../stream/stream-customize.html" title="Custom stream processing" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Custom stream processing
</span>
</div>
</a>
<a href="../stream/actor-interop.html" title="Actors interop" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Actors interop
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright Â© 2023 The Apache Software Foundation, Licensed under the Apache License, Version 2.0
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../assets/js/groups.js"></script>
</body>
</html>
