<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="How to do rolling updates and restarts with Apache Pekko Cluster.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="How to do rolling updates and restarts with Apache Pekko Cluster.">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Rolling Updates Â· Apache Pekko</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Apache Pekko" class="md-header-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Apache Pekko
</span>
<span class="md-header-nav__topic">
Rolling Updates
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Apache Pekko" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../images/pekko_logo.png" width="24" height="24">
</a>
<a href="../index.html" title="Apache Pekko">
Apache Pekko
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<ul>
  <li><a href="../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../downloads.html" class="page">Downloads</a></li>
  <li><a href="../documentation.html" class="page">Documentation</a>
  <ul>
    <li><a href="../typed/guide/index.html" class="page">Getting Started Guide</a></li>
    <li><a href="../general/index.html" class="page">General Concepts</a></li>
    <li><a href="../typed/index.html" class="page">Actors</a></li>
    <li><a href="../typed/index-cluster.html" class="page">Cluster</a></li>
    <li><a href="../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
    <li><a href="../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
    <li><a href="../stream/index.html" class="page">Streams</a></li>
    <li><a href="../discovery/index.html" class="page">Discovery</a></li>
    <li><a href="../index-utilities.html" class="page">Utilities</a></li>
    <li><a href="../common/other-modules.html" class="page">Other Apache Pekko modules</a></li>
    <li><a href="../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
    <li><a href="../project/index.html" class="page">Project Information</a></li>
    <li><a href="../index-classic.html" class="page">Pekko Classic</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../additional/rolling-updates.html#rolling-updates" class="header">Rolling Updates</a>
  <ul>
    <li><a href="../additional/rolling-updates.html#serialization-compatibility" class="header">Serialization Compatibility</a></li>
    <li><a href="../additional/rolling-updates.html#cluster-sharding" class="header">Cluster Sharding</a></li>
    <li><a href="../additional/rolling-updates.html#cluster-singleton" class="header">Cluster Singleton</a></li>
    <li><a href="../additional/rolling-updates.html#cluster-shutdown" class="header">Cluster Shutdown</a></li>
    <li><a href="../additional/rolling-updates.html#configuration-compatibility-checks" class="header">Configuration Compatibility Checks</a></li>
    <li><a href="../additional/rolling-updates.html#when-shutdown-startup-is-required" class="header">When Shutdown Startup Is Required</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.6.20+81-523134c3+20230202-1514*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../additional/rolling-updates.html#rolling-updates" class="header">Rolling Updates</a>
  <ul>
    <li><a href="../additional/rolling-updates.html#serialization-compatibility" class="header">Serialization Compatibility</a></li>
    <li><a href="../additional/rolling-updates.html#cluster-sharding" class="header">Cluster Sharding</a></li>
    <li><a href="../additional/rolling-updates.html#cluster-singleton" class="header">Cluster Singleton</a></li>
    <li><a href="../additional/rolling-updates.html#cluster-shutdown" class="header">Cluster Shutdown</a></li>
    <li><a href="../additional/rolling-updates.html#configuration-compatibility-checks" class="header">Configuration Compatibility Checks</a></li>
    <li><a href="../additional/rolling-updates.html#when-shutdown-startup-is-required" class="header">When Shutdown Startup Is Required</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#rolling-updates" name="rolling-updates" class="anchor"><span class="anchor-link"></span></a>Rolling Updates</h1><div class="callout note "><div class="callout-title">Note</div>
<p>There are a few instances <a href="rolling-updates.html#when-shutdown-startup-is-required">when a full cluster restart is required</a> versus being able to do a rolling update.</p></div>
<p>A rolling update is the process of replacing one version of the system with another without downtime. The changes can be new code, changed dependencies such as new Pekko version, or modified configuration.</p>
<p>In Apache Pekko, rolling updates are typically used for a stateful Pekko Cluster where you can&rsquo;t run two separate clusters in parallel during the update, for example in blue green deployments.</p>
<p>For rolling updates related to Pekko dependency version upgrades and the migration guides, please see <a href="../project/rolling-update.html">Rolling Updates and Pekko versions</a></p>
<h2><a href="#serialization-compatibility" name="serialization-compatibility" class="anchor"><span class="anchor-link"></span></a>Serialization Compatibility</h2>
<p>There are two parts of Pekko that need careful consideration when performing an rolling update.</p>
<ol>
  <li>Compatibility of remote message protocols. Old nodes may send messages to new nodes and vice versa.</li>
  <li>Serialization format of persisted events and snapshots. New nodes must be able to read old data, and  during the update old nodes must be able to read data stored by new nodes.</li>
</ol>
<p>There are many more application specific aspects for serialization changes during rolling updates to consider. For example based on the use case and requirements, whether to allow dropped messages or tear down the TCP connection when the manifest is unknown. When some message loss during a rolling update is acceptable versus a full shutdown and restart, assuming the application recovers afterwards * If a <code>java.io.NotSerializableException</code> is thrown in <code>fromBinary</code> this is treated as a transient problem, the issue logged and the message is dropped * If other exceptions are thrown it can be an indication of corrupt bytes from the underlying transport, and the connection is broken</p>
<p>For more zero-impact rolling updates, it is important to consider a strategy for serialization that can be evolved. One approach to retiring a serializer without downtime is described in <a href="../serialization.html#rolling-updates">two rolling update steps to switch to the new serializer</a>. Additionally you can find advice on <a href="../persistence-schema-evolution.html">Persistence - Schema Evolution</a> which also applies to remote messages when deploying with rolling updates.</p>
<h2><a href="#cluster-sharding" name="cluster-sharding" class="anchor"><span class="anchor-link"></span></a>Cluster Sharding</h2>
<p>During a rolling update, sharded entities receiving traffic may be moved, based on the pluggable allocation strategy and settings. When an old node is stopped the shards that were running on it are moved to one of the other remaining nodes in the cluster when messages are sent to those shards.</p>
<p>To make rolling updates as smooth as possible there is a configuration property that defines the version of the application. This is used by rolling update features to distinguish between old and new nodes. For example, the default <code>LeastShardAllocationStrategy</code> avoids allocating shards to old nodes during a rolling update. The <code>LeastShardAllocationStrategy</code> sees that there is rolling update in progress when there are members with different configured <code>app-version</code>.</p>
<p>To make use of this feature you need to define the <code>app-version</code> and increase it for each rolling update.</p>
<pre><code>pekko.cluster.app-version = 1.2.3
</code></pre>
<p>To understand which is old and new it compares the version numbers using normal conventions, see <span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/util/Version.html" title="org.apache.pekko.util.Version"><code>Version</code></a></span><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/util/Version.html" title="org.apache.pekko.util.Version"><code>Version</code></a></span> for more details.</p>
<p>Rebalance is also disabled during rolling updates, since shards from stopped nodes are anyway supposed to be started on new nodes. Messages to shards that were stopped on the old nodes will allocate corresponding shards on the new nodes, without waiting for rebalance actions. </p>
<p>You should also enable the <a href="../typed/cluster-sharding.html#health-check">health check for Cluster Sharding</a> if you use Pekko Management. The readiness check will delay incoming traffic to the node until Sharding has been initialized and can accept messages.</p>
<p>The <code>ShardCoordinator</code> is itself a cluster singleton. To minimize downtime of the shard coordinator, see the strategies about <a href="rolling-updates.html#cluster-singleton">ClusterSingleton</a> rolling updates below.</p>
<p>A few specific changes to sharding configuration require <a href="rolling-updates.html#cluster-sharding-configuration-change">a full cluster restart</a>.</p>
<h2><a href="#cluster-singleton" name="cluster-singleton" class="anchor"><span class="anchor-link"></span></a>Cluster Singleton</h2>
<p>Cluster singletons are always running on the oldest node. To avoid moving cluster singletons more than necessary during a rolling update, it is recommended to upgrade the oldest node last. This way cluster singletons are only moved once during a full rolling update. Otherwise, in the worst case cluster singletons may be migrated from node to node which requires coordination and initialization overhead several times.</p>
<p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Kubernetes Deployments</a> with <code>RollingUpdate</code> strategy will roll out updates in this preferred order, from newest to oldest. </p>
<h2><a href="#cluster-shutdown" name="cluster-shutdown" class="anchor"><span class="anchor-link"></span></a>Cluster Shutdown</h2>
<h3><a href="#graceful-shutdown" name="graceful-shutdown" class="anchor"><span class="anchor-link"></span></a>Graceful shutdown</h3>
<p>For rolling updates it is best to leave the Cluster gracefully via <a href="../coordinated-shutdown.html">Coordinated Shutdown</a>, which will run automatically on SIGTERM, when the Cluster node sees itself as <code>Exiting</code>. Environments such as Kubernetes send a SIGTERM, however if the JVM is wrapped with a script ensure that it forwards the signal. <a href="../cluster-sharding.html#graceful-shutdown">Graceful shutdown</a> of Cluster Singletons and Cluster Sharding similarly happen automatically.</p>
<h3><a href="#ungraceful-shutdown" name="ungraceful-shutdown" class="anchor"><span class="anchor-link"></span></a>Ungraceful shutdown</h3>
<p>In case of network failures it may still be necessary to set the node&rsquo;s status to Down in order to complete the removal. <a href="../typed/cluster.html#downing">Cluster Downing</a> details downing nodes and downing providers. <a href="../split-brain-resolver.html">Split Brain Resolver</a> can be used to ensure the cluster continues to function during network partitions and node failures. For example if there is an unreachability problem Split Brain Resolver would make a decision based on the configured downing strategy. </p>
<h2><a href="#configuration-compatibility-checks" name="configuration-compatibility-checks" class="anchor"><span class="anchor-link"></span></a>Configuration Compatibility Checks</h2>
<p>During rolling updates the configuration from existing nodes should pass the Cluster configuration compatibility checks. For example, it is possible to migrate Cluster Sharding from Classic to Typed Actors in a rolling update using a two step approach:</p>
<ul>
  <li>Deploy with the new nodes set to <code>pekko.cluster.configuration-compatibility-check.enforce-on-join = off</code> and ensure all nodes are in this state</li>
  <li>Deploy again and with the new nodes set to <code>pekko.cluster.configuration-compatibility-check.enforce-on-join = on</code>.</li>
</ul>
<p>Full documentation about enforcing these checks on joining nodes and optionally adding custom checks can be found in<br/><a href="../typed/cluster.html#configuration-compatibility-check">Pekko Cluster configuration compatibility checks</a>.</p>
<h2><a href="#when-shutdown-startup-is-required" name="when-shutdown-startup-is-required" class="anchor"><span class="anchor-link"></span></a>When Shutdown Startup Is Required</h2>
<p>There are a few instances when a full shutdown and startup is required versus being able to do a rolling update.</p>
<h3><a href="#cluster-sharding-configuration-change" name="cluster-sharding-configuration-change" class="anchor"><span class="anchor-link"></span></a>Cluster Sharding configuration change</h3>
<p>If you need to change any of the following aspects of sharding it will require a full cluster restart versus a rolling update:</p>
<ul>
  <li>The <code>extractShardId</code> function</li>
  <li>The role that the shard regions run on</li>
  <li>The persistence mode - It&rsquo;s important to use the same mode on all nodes in the cluster</li>
  <li>The <a href="../typed/cluster-sharding.html#basic-example"><code>number-of-shards</code></a> - Note: changing the number  of nodes in the cluster does not require changing the number of shards.</li>
</ul>
<h3><a href="#cluster-configuration-change" name="cluster-configuration-change" class="anchor"><span class="anchor-link"></span></a>Cluster configuration change</h3>
<ul>
  <li>A full restart is required if you change the <a href="https://pekko.apache.org/docs/pekko/current/split-brain-resolver.html#strategies">SBR strategy</a></li>
</ul>
<h3><a href="#migrating-from-persistentfsm-to-eventsourcedbehavior" name="migrating-from-persistentfsm-to-eventsourcedbehavior" class="anchor"><span class="anchor-link"></span></a>Migrating from PersistentFSM to EventSourcedBehavior</h3>
<p>If you&rsquo;ve <a href="../persistence-fsm.html#migration-to-eventsourcedbehavior">migrated from <code>PersistentFSM</code> to <code>EventSourcedBehavior</code></a> and are using PersistenceFSM with Cluster Sharding, a full shutdown is required as shards can move between new and old nodes.</p>
<h3><a href="#migrating-from-classic-remoting-to-artery" name="migrating-from-classic-remoting-to-artery" class="anchor"><span class="anchor-link"></span></a>Migrating from classic remoting to Artery</h3>
<p>If you&rsquo;ve migrated from classic remoting to Artery which has a completely different protocol, a rolling update is not supported.</p>
<h3><a href="#changing-remoting-transport" name="changing-remoting-transport" class="anchor"><span class="anchor-link"></span></a>Changing remoting transport</h3>
<p>Rolling update is not supported when <a href="../remoting-artery.html#selecting-a-transport">changing the remoting transport</a>.</p>
<h3><a href="#migrating-from-classic-sharding-to-typed-sharding" name="migrating-from-classic-sharding-to-typed-sharding" class="anchor"><span class="anchor-link"></span></a>Migrating from Classic Sharding to Typed Sharding</h3>
<p>If you have been using classic sharding it is possible to do a rolling update to typed sharding using a 3 step procedure. The steps along with example commits are detailed in <a href="https://github.com/akka/akka-samples/pull/110">this sample PR</a> </p>
</div>
<div>
<a href="https://github.com/apache/incubator-pekko/tree/main/docs/src/main/paradox/additional/rolling-updates.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.6.20+81-523134c3+20230202-1514*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../additional/deploying.html" title="Deploying" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Deploying
</span>
</div>
</a>
<a href="../project/index.html" title="Project Information" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Project Information
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright Â© 2023 The Apache Software Foundation, Licensed under the Apache License, Version 2.0
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../assets/js/groups.js"></script>
</body>
</html>
