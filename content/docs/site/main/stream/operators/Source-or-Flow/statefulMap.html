<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="[\s\-]+">


<meta name="description" content="Apache Pekko is a toolkit for building highly concurrent, distributed, and resilient message-driven applications for Java and Scala.">
<link rel="shortcut icon" href="../../../assets/images/favicon.png">
<title>statefulMap · Apache Pekko</title>
<link rel="stylesheet" href="../../../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../../../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../../../lib/prettify/prettify.css">
<script src="../../../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../../../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../../../index.html" title="Apache Pekko" class="md-header-nav__button md-logo">
<img src="../../../images/pekko_logo.png" width="24" height="24">
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Apache Pekko
</span>
<span class="md-header-nav__topic">
statefulMap
</span>
</div>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
<label class="md-icon md-search__icon" for="__search"></label>
<button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">&#xE5CD;</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix>
<div class="md-search-result" data-md-component="result">
<div class="md-search-result__meta">
Type to start searching
</div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>

</div>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../../../index.html" title="Apache Pekko" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<img src="../../../images/pekko_logo.png" width="24" height="24">
</a>
<a href="../../../index.html" title="Apache Pekko">
Apache Pekko
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/apache/incubator-pekko"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
apache/incubator-pekko
</div>
</a>

</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<ul>
  <li><a href="../../../security/index.html" class="page">Security Announcements</a></li>
  <li><a href="../../../downloads.html" class="page">Downloads</a></li>
  <li><a href="../../../documentation.html" class="page">Documentation</a>
  <ul>
    <li><a href="../../../typed/guide/index.html" class="page">Getting Started Guide</a></li>
    <li><a href="../../../general/index.html" class="page">General Concepts</a></li>
    <li><a href="../../../typed/index.html" class="page">Actors</a></li>
    <li><a href="../../../typed/index-cluster.html" class="page">Cluster</a></li>
    <li><a href="../../../typed/index-persistence.html" class="page">Persistence (Event Sourcing)</a></li>
    <li><a href="../../../typed/index-persistence-durable-state.html" class="page">Persistence (Durable State)</a></li>
    <li><a href="../../../stream/index.html" class="page">Streams</a></li>
    <li><a href="../../../discovery/index.html" class="page">Discovery</a></li>
    <li><a href="../../../index-utilities.html" class="page">Utilities</a></li>
    <li><a href="../../../common/other-modules.html" class="page">Other Apache Pekko modules</a></li>
    <li><a href="../../../additional/deploy.html" class="page">Package, Deploy and Run</a></li>
    <li><a href="../../../project/index.html" class="page">Project Information</a></li>
    <li><a href="../../../index-classic.html" class="page">Pekko Classic</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#statefulmap" class="header">statefulMap</a>
  <ul>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#signature" class="header">Signature</a></li>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#description" class="header">Description</a></li>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#examples" class="header">Examples</a></li>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#reactive-streams-semantics" class="header">Reactive Streams semantics</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 2.6.20+81-523134c3+20230202-1514*
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#statefulmap" class="header">statefulMap</a>
  <ul>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#signature" class="header">Signature</a></li>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#description" class="header">Description</a></li>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#examples" class="header">Examples</a></li>
    <li><a href="../../../stream/operators/Source-or-Flow/statefulMap.html#reactive-streams-semantics" class="header">Reactive Streams semantics</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#statefulmap" name="statefulmap" class="anchor"><span class="anchor-link"></span></a>statefulMap</h1>
<p>Transform each stream element with the help of a state.</p>
<p><a href="../index.html#simple-operators">Simple operators</a></p>
<h2><a href="#signature" name="signature" class="anchor"><span class="anchor-link"></span></a>Signature</h2>
<p><span class="group-java"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/stream/javadsl/Flow.html#statefulMap(org.apache.pekko.japi.function.Creator,org.apache.pekko.japi.function.Function2,org.apache.pekko.japi.function.Function)" title="org.apache.pekko.stream.javadsl.Flow"><code>Flow.statefulMap</code></a></span><span class="group-scala"><a href="https://pekko.apache.org/api/pekko/2.6.20+81-523134c3+20230202-1514-SNAPSHOT/org/apache/pekko/stream/scaladsl/Flow.html#statefulMap[S,T](create:()=%3ES)(f:(S,Out)%20=%3E(S,T),onComplete:S=%3EOption[T]):Repr[T]" title="org.apache.pekko.stream.scaladsl.Flow"><code>Flow.statefulMap</code></a></span></p>
<h2><a href="#description" name="description" class="anchor"><span class="anchor-link"></span></a>Description</h2>
<p>Transform each stream element with the help of a state. </p>
<p>The state creation function is invoked once when the stream is materialized and the returned state is passed to the mapping function for mapping the first element. </p>
<p>The mapping function returns a mapped element to emit downstream and a state to pass to the next mapping function. The state can be the same for each mapping return, be a new immutable state but it is also safe to use a mutable state.</p>
<p>The on complete function is called, once, when the first of upstream completion, downstream cancellation or stream failure happens. If the cause is upstream completion and the downstream is still accepting elements, the returned value from the function is passed downstream before completing the operator itself, for the other cases the returned value is ignored.</p>
<p>The <code>statefulMap</code> operator adheres to the ActorAttributes.SupervisionStrategy attribute.</p>
<p>For mapping stream elements without keeping a state see <a href="map.html">map</a>.</p>
<h2><a href="#examples" name="examples" class="anchor"><span class="anchor-link"></span></a>Examples</h2>
<p>In the first example we implement an <code>zipWithIndex</code> operator like <a href="zipWithIndex.html">zipWithIndex</a>, it always associates a unique index with each element of the stream, the index starts from 0.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/operators/flow/StatefulMap.scala#L24-L31" target="_blank" title="Go to snippet source">source</a><code class="language-scala">Source(List(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;))
  .statefulMap(() =&gt; 0L)((index, elem) =&gt; (index + 1, (elem, index)), _ =&gt; None)
  .runForeach(println)
// prints
// (A,0)
// (B,1)
// (C,2)
// (D,3)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/operators/flow/StatefulMap.java#L29-L39" target="_blank" title="Go to snippet source">source</a><code class="language-java">Source.from(Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;))
    .statefulMap(
        () -&gt; 0L,
        (index, element) -&gt; Pair.create(index + 1, Pair.create(element, index)),
        indexOnComplete -&gt; Optional.empty())
    .runForeach(System.out::println, system);
// prints
// Pair(A,0)
// Pair(B,1)
// Pair(C,2)
// Pair(D,3)</code></pre></dd>
</dl>
<p>In the second example, the elements are buffered until the incoming element is different, and then emitted downstream. When upstream completes, if there are buffered elements, they are emitted before completing.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/operators/flow/StatefulMap.scala#L37-L51" target="_blank" title="Go to snippet source">source</a><code class="language-scala">Source(&quot;A&quot; :: &quot;B&quot; :: &quot;B&quot; :: &quot;C&quot; :: &quot;C&quot; :: &quot;C&quot; :: &quot;D&quot; :: Nil)
  .statefulMap(() =&gt; List.empty[String])(
    (buffer, element) =&gt;
      buffer match {
        case head :: _ if head != element =&gt; (element :: Nil, buffer)
        case _                            =&gt; (element :: buffer, Nil)
      },
    buffer =&gt; Some(buffer))
  .filter(_.nonEmpty)
  .runForeach(println)
// prints
// List(A)
// List(B, B)
// List(C, C, C)
// List(D)</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/operators/flow/StatefulMap.java#L45-L65" target="_blank" title="Go to snippet source">source</a><code class="language-java">Source.from(Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;B&quot;, &quot;C&quot;, &quot;C&quot;, &quot;C&quot;, &quot;D&quot;))
    .statefulMap(
        () -&gt; (List&lt;String&gt;) new LinkedList&lt;String&gt;(),
        (buffer, element) -&gt; {
          if (buffer.size() &gt; 0 &amp;&amp; (!buffer.get(0).equals(element))) {
            return Pair.create(
                new LinkedList&lt;&gt;(Collections.singletonList(element)),
                Collections.unmodifiableList(buffer));
          } else {
            buffer.add(element);
            return Pair.create(buffer, Collections.&lt;String&gt;emptyList());
          }
        },
        Optional::ofNullable)
    .filterNot(List::isEmpty)
    .runForeach(System.out::println, system);
// prints
// [A]
// [B, B]
// [C, C, C]
// [D]</code></pre></dd>
</dl>
<p>In the forth example, repeated incoming elements are only emitted once and then dropped.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/operators/flow/StatefulMap.scala#L57-L71" target="_blank" title="Go to snippet source">source</a><code class="language-scala">Source(&quot;A&quot; :: &quot;B&quot; :: &quot;B&quot; :: &quot;C&quot; :: &quot;C&quot; :: &quot;C&quot; :: &quot;D&quot; :: Nil)
  .statefulMap(() =&gt; Option.empty[String])(
    (lastElement, elem) =&gt;
      lastElement match {
        case Some(head) if head == elem =&gt; (Some(elem), None)
        case _                          =&gt; (Some(elem), Some(elem))
      },
    _ =&gt; None)
  .collect { case Some(elem) =&gt; elem }
  .runForeach(println)
// prints
// A
// B
// C
// D</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/operators/flow/StatefulMap.java#L71-L88" target="_blank" title="Go to snippet source">source</a><code class="language-java">Source.from(Arrays.asList(&quot;A&quot;, &quot;B&quot;, &quot;B&quot;, &quot;C&quot;, &quot;C&quot;, &quot;C&quot;, &quot;D&quot;))
    .statefulMap(
        Optional::&lt;String&gt;empty,
        (lastElement, element) -&gt; {
          if (lastElement.isPresent() &amp;&amp; lastElement.get().equals(element)) {
            return Pair.create(lastElement, Optional.&lt;String&gt;empty());
          } else {
            return Pair.create(Optional.of(element), Optional.of(element));
          }
        },
        listOnComplete -&gt; Optional.empty())
    .via(Flow.flattenOptional())
    .runForeach(System.out::println, system);
// prints
// A
// B
// C
// D</code></pre></dd>
</dl>
<p>In the fifth example, we combine the <a href="statefulMap.html">statefulMap</a> and <a href="mapConcat.html">mapConcat</a> to implement a <a href="statefulMapConcat.html">statefulMapConcat</a> like behavior.</p>
<dl>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/scala/docs/stream/operators/flow/StatefulMap.scala#L77-L100" target="_blank" title="Go to snippet source">source</a><code class="language-scala">Source(1 to 10)
  .statefulMap(() =&gt; List.empty[Int])(
    (state, elem) =&gt; {
      // grouped 3 elements into a list
      val newState = elem :: state
      if (newState.size == 3)
        (Nil, newState.reverse)
      else
        (newState, Nil)
    },
    state =&gt; Some(state.reverse))
  .mapConcat(identity)
  .runForeach(println)
// prints
// 1
// 2
// 3
// 4
// 5
// 6
// 7
// 8
// 9
// 10</code></pre></dd>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/apache/incubator-pekko/tree/main/docs/src/test/java/jdocs/stream/operators/flow/StatefulMap.java#L94-L118" target="_blank" title="Go to snippet source">source</a><code class="language-java">Source.fromJavaStream(() -&gt; IntStream.rangeClosed(1, 10))
    .statefulMap(
        () -&gt; new ArrayList&lt;Integer&gt;(3),
        (list, element) -&gt; {
          list.add(element);
          if (list.size() == 3) {
            return Pair.create(new ArrayList&lt;Integer&gt;(3), Collections.unmodifiableList(list));
          } else {
            return Pair.create(list, Collections.&lt;Integer&gt;emptyList());
          }
        },
        Optional::ofNullable)
    .mapConcat(list -&gt; list)
    .runForeach(System.out::println, system);
// prints
// 1
// 2
// 3
// 4
// 5
// 6
// 7
// 8
// 9
// 10</code></pre></dd>
</dl>
<h2><a href="#reactive-streams-semantics" name="reactive-streams-semantics" class="anchor"><span class="anchor-link"></span></a>Reactive Streams semantics</h2><div class="callout">
<p><strong>emits</strong> the mapping function returns an element and downstream is ready to consume it</p>
<p><strong>backpressures</strong> downstream backpressures</p>
<p><strong>completes</strong> upstream completes</p>
<p><strong>cancels</strong> downstream cancels</p></div>
</div>
<div>
<a href="https://github.com/apache/incubator-pekko/tree/main/docs/src/main/paradox/stream/operators/Source-or-Flow/statefulMap.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
2.6.20+81-523134c3+20230202-1514*
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../../../stream/operators/Source-or-Flow/splitWhen.html" title="splitWhen" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
splitWhen
</span>
</div>
</a>
<a href="../../../stream/operators/Source-or-Flow/statefulMapConcat.html" title="statefulMapConcat" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
statefulMapConcat
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright © 2023 The Apache Software Foundation, Licensed under the Apache License, Version 2.0
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
</div>
</div>
</footer>

</div>
<script src="../../../assets/javascripts/application.583bbe55.js"></script>
<script src="../../../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../../../."}})</script>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script src="../../../assets/js/groups.js"></script>
</body>
</html>
